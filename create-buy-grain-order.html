<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>New Order</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: "Inter", system-ui, sans-serif; }
  </style>
  <script defer src="/common.js"></script>
</head>
<body class="bg-gray-50 min-h-screen p-4">
  <div class="max-w-3xl mx-auto">
    <div class="bg-white shadow-md rounded-xl p-6">
      <h2 class="text-2xl font-bold mb-4">New Order (By Grain)</h2>

      <div id="user-info" class="mb-4 text-gray-700"></div>

      <!-- Order Type Summary (added back as requested) -->
      <div id="selection-summary" class="mb-4 text-sm text-gray-700 hidden">
        <strong class="text-gray-800">Order Type: </strong>
        <span id="selection-summary-text" class="text-indigo-600"></span>
      </div>

      <!-- Inline information message placed right after Order Type line -->
      <div id="delivery-info" class="mb-4">
        <div role="status" aria-live="polite" class="inline-flex items-start gap-3 rounded-md bg-blue-50 border border-blue-100 px-3 py-2 text-sm text-blue-800">
          <!-- small info icon (SVG) -->
          <svg class="w-4 h-4 flex-shrink-0 mt-0.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M18 10A8 8 0 1 1 2 10a8 8 0 0 1 16 0zm-8-4a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm1 8a1 1 0 0 1-2 0v-4a1 1 0 0 1 2 0v4z" clip-rule="evenodd"/>
          </svg>

          <div class="leading-tight">
            <span class="font-medium">Delivery timings:</span>
            <span class="ml-1">7pm to 9pm every day — orders booked before 5pm will be delivered same day.</span>
          </div>
        </div>
      </div>

      <hr class="my-4">

      <div id="order-rows" class="space-y-4"></div>

      <!-- Totals -->
      <div class="bg-gray-50 p-4 rounded-lg mb-4">
        <h3 class="font-semibold mb-1">Order Summary</h3>
        <p class="text-xs text-gray-500 mb-2">*Values are rounded off to the nearest number</p>

        <div class="flex justify-between text-gray-600">
          <span>Selected Items</span>
          <span id="total-items">0</span>
        </div>
        <div class="flex justify-between text-gray-600">
          <span>Total Quantity</span>
          <span id="total-qty">0 kg</span>
        </div>
        <div class="flex justify-between text-gray-600">
          <span>Milling Charges</span>
          <span>₹<span id="milling-total">0</span></span>
        </div>

        <!-- Delivery Charges (NEW) -->
        <div id="delivery-row" class="flex justify-between text-gray-600" style="display:none;">
          <span>Delivery Charges</span>
          <span>₹<span id="delivery-cost">0</span></span>
        </div>

        <div class="flex justify-between font-bold text-lg border-t pt-2 mt-2">
          <span>Total Price</span>
          <span>₹<span id="total-price">0</span></span>
        </div>

        <!-- NEW Grand Total row -->
        <div class="flex justify-between font-bold text-lg border-t pt-2 mt-3">
          <span>Grand Total</span>
          <span>₹<span id="grand-total">0</span></span>
        </div>
      </div>

      <div class="flex space-x-3">
        <button id="submit-btn" onclick="submitOrder()" class="flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700">
          Create Order
        </button>

        <!-- CANCEL → BACK -->
        <button onclick="history.back()" class="flex-1 border border-gray-300 py-2 px-4 rounded-lg hover:bg-gray-100">
          Back
        </button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden fixed bottom-5 right-5 bg-green-600 text-white px-4 py-2 rounded shadow"></div>

  <script src="config.js"></script>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = window._env_.SUPABASE_URL;
    const SUPABASE_KEY = window._env_.SUPABASE_ANON_KEY;
  
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const urlParams = new URLSearchParams(window.location.search);
    const phone = urlParams.get('phone');
    let user = null;
    let deliveryCharge = 0;
    let isSubmitting = false;

    const orderRows = document.getElementById("order-rows");
    const totalItemsEl = document.getElementById("total-items");
    const totalQtyEl = document.getElementById("total-qty");
    const millingTotalEl = document.getElementById("milling-total");
    const totalPriceEl = document.getElementById("total-price");
    const grandTotalEl = document.getElementById("grand-total");
    const toast = document.getElementById("toast");
    const deliveryRowEl = document.getElementById("delivery-row");
    const deliveryCostEl = document.getElementById("delivery-cost");

    function showToast(message, type = "success") {
      toast.textContent = message;
      toast.className = `fixed bottom-5 right-5 px-4 py-2 rounded shadow text-white ${
        type === "success" ? "bg-green-600" : "bg-red-600"
      }`;
      toast.style.display = "block";
      setTimeout(() => { toast.style.display = "none"; }, 3000);
    }

    function computeSelectionSummary() {
      const serveAt = localStorage.getItem('serveAt') || '';
      const orderType = (localStorage.getItem('orderType') || '').toLowerCase();

      if (orderType.includes('home') && orderType.includes('buy')) return "Home delivery — Atta Order";
      if (orderType.includes('shop') && orderType.includes('buy')) return "At shop — Atta Order";
      if (orderType.includes('home')) return "Home delivery — Pickup & Drop";
      if (orderType.includes('shop')) return "At shop — Pickup & Drop";

      return serveAt.toLowerCase().includes('home') ? "Home delivery" : "At shop";
    }

    function updateSelectionSummaryDisplay() {
      const text = computeSelectionSummary();
      const el = document.getElementById("selection-summary");
      document.getElementById("selection-summary-text").textContent = text;
      el.style.display = text ? "block" : "none";
    }

    async function loadUser() {
      const { data } = await supabase
        .from("customers")
        .select("*")
        .eq("phone_number", phone)
        .maybeSingle();

      user = data;
      document.getElementById("user-info").innerHTML = `
        <p><strong>Name:</strong> ${user?.name || ''}</p>
        <p><strong>Mobile:</strong> ${user?.phone_number || ''}</p>
        <p><strong>Flat:</strong> ${user?.flat_number || ''}, ${user?.wing || ''}</p>
        <p><strong>Society:</strong> ${user?.society_name || ''}</p>
      `;

      updateSelectionSummaryDisplay();
    }

    async function loadGrains() {
      const { data: grains } = await supabase
        .from("Grain_for_sell")
        .select("*")
        .eq("is_active", true);

      grains.forEach(g => {
        const row = document.createElement("div");
        row.className = "p-3 border rounded-lg shadow-sm bg-gray-50 space-y-2";

        row.innerHTML = `
          <div class="flex items-center gap-3">
            <input type="checkbox" class="grain-check"/>
            <div class="grain-name flex-1 font-semibold">${g.product_name}</div>
            <input type="number" min="1" placeholder="Qty (kg)" class="grain-qty w-20 p-2 border rounded"/>
          </div>
          <div class="flex flex-col text-sm text-gray-700">
            <span class="price" data-price="${g.price_per_kg}">Grain Price: ₹${g.price_per_kg}/kg</span>
            <span class="milling" data-milling="${g.milling_price_per_kg || 0}">Milling Price: ₹${g.milling_price_per_kg || 0}/kg</span>
            <span>Total: ₹<span class="row-total">0</span></span>
          </div>
          <div class="error text-red-500 text-sm"></div>
        `;

        const check = row.querySelector(".grain-check");
        const qtyInput = row.querySelector(".grain-qty");
        const errorEl = row.querySelector(".error");

        check.addEventListener("change", () => {
          errorEl.textContent = "";
          if (!check.checked) qtyInput.value = "";
          updateTotals();
        });

        qtyInput.addEventListener("input", () => {
          if (qtyInput.value > 0) check.checked = true;
          updateTotals();
        });

        orderRows.appendChild(row);
      });
    }

    function updateTotals() {
      let totalItems = 0, totalQty = 0, totalPrice = 0, millingTotal = 0;

      [...orderRows.querySelectorAll(".p-3")].forEach(row => {
        const check = row.querySelector(".grain-check");
        const qtyInput = row.querySelector(".grain-qty");
        const totalEl = row.querySelector(".row-total");
        const price = parseFloat(row.querySelector(".price").dataset.price);
        const milling = parseFloat(row.querySelector(".milling").dataset.milling);

        if (check.checked && qtyInput.value > 0) {
          const qty = parseFloat(qtyInput.value);
          const rowTotal = (price + milling) * qty;
          totalEl.textContent = rowTotal.toFixed(2);

          totalItems++;
          totalQty += qty;
          totalPrice += rowTotal;
          millingTotal += milling * qty;
        } else {
          totalEl.textContent = "0";
        }
      });

      totalItemsEl.textContent = totalItems;
      totalQtyEl.textContent = totalQty;
      millingTotalEl.textContent = Math.round(millingTotal);
      totalPriceEl.textContent = Math.round(totalPrice);

      updateDeliveryCharge(totalPrice);
    }

    async function updateDeliveryCharge(subtotal) {
      const serveAt = (localStorage.getItem('serveAt') || '').toLowerCase();

      if (!serveAt.includes('home')) {
        deliveryCharge = 0;
        deliveryRowEl.style.display = 'none';
        deliveryCostEl.textContent = `0`;
        grandTotalEl.textContent = Math.round(subtotal);
        return;
      }

      let foundPrice = 0;
      const societyId = user?.society_id || null;

      // 1) Society specific
      if (societyId) {
        const { data } = await supabase
          .from("delivery_pricing")
          .select("price")
          .eq("delivery_type", "normal")
          .eq("is_active", true)
          .eq("society_id", societyId)
          .maybeSingle();

        if (data?.price != null) foundPrice = Number(data.price);
      }

      // 2) Global
      if (!foundPrice) {
        const { data } = await supabase
          .from("delivery_pricing")
          .select("price")
          .eq("delivery_type", "normal")
          .eq("is_active", true)
          .is("society_id", null)
          .maybeSingle();

        if (data?.price != null) foundPrice = Number(data.price);
      }

      // 3) Fallback
      if (!foundPrice) {
        const { data } = await supabase
          .from("delivery_pricing")
          .select("price")
          .eq("delivery_type", "normal")
          .eq("is_active", true)
          .limit(1);

        if (data?.[0]?.price != null) foundPrice = Number(data[0].price);
      }

      deliveryCharge = foundPrice || 0;

      if (deliveryCharge > 0) {
        deliveryRowEl.style.display = 'flex';
        deliveryCostEl.textContent = deliveryCharge;
      } else {
        deliveryRowEl.style.display = 'none';
        deliveryCostEl.textContent = 0;
      }

      grandTotalEl.textContent = Math.round(subtotal + deliveryCharge);
    }

    window.submitOrder = async function () {
      if (isSubmitting) return;
      isSubmitting = true;

      const btn = document.getElementById("submit-btn");
      btn.disabled = true;
      btn.textContent = "Processing...";

      let grainDetails = [];
      let hasError = false;

      [...orderRows.querySelectorAll(".p-3")].forEach(row => {
        const check = row.querySelector(".grain-check");
        if (!check.checked) return;

        const qtyInput = row.querySelector(".grain-qty");
        const name = row.querySelector(".grain-name").textContent.trim();
        const price = parseFloat(row.querySelector(".price").dataset.price);
        const milling = parseFloat(row.querySelector(".milling").dataset.milling);
        const qty = parseFloat(qtyInput.value || 0);
        const total = (price + milling) * qty;

        if (qty <= 0) hasError = true;
        else grainDetails.push({ grain: name, quantity: qty, price, milling, total });
      });

      if (hasError || grainDetails.length === 0) {
        showToast("Fix errors before submitting", "error");
        btn.disabled = false;
        btn.textContent = "Create Order";
        isSubmitting = false;
        return;
      }

      const subtotal = Number(totalPriceEl.textContent);
      const grandTotal = Number(grandTotalEl.textContent);

      const inactiveStatuses = ["DELIVERED", "CANCELLED", "REJECTED"];

      async function generateTokenNumber() {
        const { data: activeOrders } = await supabase
          .from("orders")
          .select("token_number, order_statuses!inner(status_name)")
          .not("order_statuses.status_name", "in", `(${inactiveStatuses.map(s => `'${s}'`).join(",")})`);

        const activeTokens = new Set(activeOrders.map(o => o.token_number));
        let maxTokenNum = 0;

        activeTokens.forEach(token => {
          const num = parseInt(token.slice(2), 10);
          if (num > maxTokenNum) maxTokenNum = num;
        });

        for (let i = 1; i <= 999; i++) {
          let next = maxTokenNum + i;
          if (next > 999) next -= 999;
          const token = `QA${next}`;
          if (!activeTokens.has(token)) return token;
        }
      }

      const token = await generateTokenNumber();

      const { data: statusData } = await supabase
        .from("order_statuses")
        .select("id")
        .eq("status_name", "NEW")
        .maybeSingle();

      const statusId = statusData?.id || null;

      const { error } = await supabase.from("orders").insert([{
        customer_id: user.id,
        grain_details: grainDetails,
        total_price: grandTotal,
        token_number: token,
        order_type: localStorage.getItem("orderType") || "",
        serve_at: localStorage.getItem("serveAt") || "",
        status_id: statusId
      }]);

      if (error) {
        showToast("❌ Failed to place order", "error");
        btn.disabled = false;
        btn.textContent = "Create Order";
        isSubmitting = false;
        return;
      }

      showToast("✅ Order placed! Token: " + token);
      setTimeout(() => {
        window.location.href = '/my-orders.html?phone=' + phone + '&token=' + token;
      }, 1500);
    };

    loadUser();
    loadGrains();
  </script>
</body>
</html>

