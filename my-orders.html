<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Orders New</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
  <style>
    body { font-family: "Inter", sans-serif; }
  </style>
  <script defer src="/common.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

  <!-- Toast -->
  <div id="toast" 
    class="fixed top-5 right-5 bg-green-500 text-white px-4 py-2 rounded shadow-lg hidden z-50">
  </div>

  <!-- Header Card -->
  <div class="bg-white shadow rounded-lg p-4 mb-6">
    <div class="flex flex-wrap items-center justify-between gap-4">
      <div>
        <h2 class="text-xl font-bold text-gray-800">My Orders</h2>
        <div id="user-info" class="text-sm text-gray-600 mt-1"></div>
      </div>
      <div class="flex gap-2">
        <button onclick="loadOrders()" 
          class="px-3 py-2 text-sm bg-gray-200 rounded hover:bg-gray-300">
          Refresh
        </button>
        <a id="newOrderBtn" 
           class="px-3 py-2 text-sm bg-blue-500 text-white rounded hover:bg-blue-600">
          New Order
        </a>
      </div>
    </div>
  </div>

  <!-- Orders -->
  <div id="orders-container" class="space-y-4"></div>

  <!-- 1) Supabase global CDN (non-module) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- 2) Load config (must populate window._env_) -->
  <script src="config.js"></script>

  <!-- 3) Guard: create a single window.supabaseClient only when config is valid -->
  <script>
    (function initSupabaseGuard(){
      const SUPABASE_URL = window._env_?.SUPABASE_URL ?? null;
      const SUPABASE_KEY = window._env_?.SUPABASE_ANON_KEY ?? null;

      console.groupCollapsed('[Supabase Guard]');
      console.log('window._env_ present?', !!window._env_);
      console.log('SUPABASE_URL host:', SUPABASE_URL ? (() => { try { return new URL(SUPABASE_URL).host } catch(e){ return SUPABASE_URL } })() : SUPABASE_URL);
      console.log('SUPABASE_KEY length:', SUPABASE_KEY ? SUPABASE_KEY.length : SUPABASE_KEY);
      console.groupEnd();

      const hasPlaceholder = (v) => !v || String(v).includes('%%') || String(v).trim() === '';

      if (hasPlaceholder(SUPABASE_URL) || hasPlaceholder(SUPABASE_KEY)) {
        console.error('[Supabase Guard] config.js missing or contains placeholders — not creating client.');
        window.supabaseClient = null;
        return;
      }

      if (window.supabase && typeof window.supabase.createClient === 'function') {
        if (!window.supabaseClient || !window.supabaseClient._initialized) {
          try {
            window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            window.supabaseClient._initialized = true;
            console.log('[Supabase Guard] window.supabaseClient created for', new URL(SUPABASE_URL).host);
          } catch (err) {
            console.error('[Supabase Guard] failed to create client', err);
            window.supabaseClient = null;
          }
        } else {
          console.log('[Supabase Guard] reusing existing window.supabaseClient');
        }
      } else {
        console.warn('[Supabase Guard] supabase global SDK not loaded yet');
        window.supabaseClient = null;
      }
    })();
  </script>

  <!-- 4) Main page logic (uses window.supabaseClient). No business logic or UI changed. -->
  <script>
    // Use the guarded global client (or null)
    const supabase = window.supabaseClient;

    // If supabase client not available, fail gracefully and show message
    if (!supabase) {
      console.warn('Supabase client not available — DB-backed UI disabled. Fix /config.js or loading order.');
      document.getElementById('orders-container').innerHTML =
        `<div class="bg-yellow-50 border border-yellow-200 rounded p-4 text-sm text-yellow-800">
            ⚠️ Supabase not configured. Check <code>/config.js</code> or environment injection. See console for details.
        </div>`;
      // Expose no-op functions so buttons don't blow up
      window.loadOrders = () => console.warn('loadOrders disabled (no supabase client)');
      window.fetchConfig = async () => null;
      window.fetchCustomer = async () => null;
      // nothing else to do.
    } else {
      // ---------- Begin original business logic ----------
      const urlParams = new URLSearchParams(window.location.search);
      const phone = urlParams.get('phone');
      let user = null;
      let millingTimePerKg = 5; // default fallback

      async function fetchConfig() {
        const { data, error } = await supabase
          .from('Configuration')
          .select('config_value')
          .eq('config_key', 'Time_for_Milling_1kg')
          .maybeSingle();

        console.log("Config fetch result:", { data, error });

        if (!error && data) {
          millingTimePerKg = Number(data.config_value) || 5;
          console.log("✅ Milling time per kg (from config):", millingTimePerKg);
        } else {
          console.warn("⚠️ Using default milling time per kg:", millingTimePerKg);
        }
      }

      function getStatusClass(status) {
        const map = {
          "NEW": "bg-yellow-100 text-yellow-800",
          "IN PROCESS": "bg-blue-100 text-blue-800",
          "MILLING COMPLETED": "bg-green-100 text-green-800",
          "DELIVERED": "bg-gray-200 text-gray-800",
          "PICKED UP": "bg-purple-100 text-purple-800",
          "RECEIVED AT MILL": "bg-orange-100 text-orange-800",
          "OUT FOR DELIVERY": "bg-pink-100 text-pink-800",
          "ARCHIVED": "bg-gray-300 text-gray-800"
        };
        return map[status] || "bg-gray-100 text-gray-700";
      }

      async function fetchCustomer() {
        const { data, error } = await supabase
          .from('customers')
          .select('*')
          .eq('phone_number', phone)
          .maybeSingle();

        if (error || !data) {
          document.getElementById('user-info').innerHTML =
            `<p class="text-red-500">Customer not found!</p>`;
          return;
        }

        user = data;
        document.getElementById('user-info').innerHTML = `
          <p><strong>${user.name}</strong> (${user.phone_number})</p>
          <p>${user.flat_number || ''} ${user.wing ? ', ' + user.wing : ''} ${user.society_name || ''}</p>
        `;

        document.getElementById("newOrderBtn").href = `select-order-type.html?phone=${phone}`;
      }

      async function loadOrders() {
        const container = document.getElementById('orders-container');
        container.innerHTML = '';

        const { data: allOrders, error } = await supabase
          .from('orders')
          .select(`
            id,
            customer_id,
            grain_details,
            total_price,
            token_number,
            created_at,
            order_type,
            serve_at,
            status_id,
            order_statuses:order_statuses!orders_status_id_fkey (
              id,
              status_name
            )
          `)
          .order('created_at', { ascending: true });

        if (error) {
          console.error(error);
          container.innerHTML = '<p class="text-red-500">Failed to load orders.</p>';
          return;
        }

        const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

        const myOrders = (allOrders || [])
          .filter(o => {
            if (o.customer_id !== user.id) return false;
            const status = o.order_statuses?.status_name;
            if (status === 'ARCHIVED') return false;
            if (status === 'DELIVERED') {
              const orderDate = new Date(o.created_at).toISOString().split('T')[0];
              return orderDate === today;
            }
            return ['NEW','PICKED UP','RECEIVED AT MILL','IN PROCESS','MILLING COMPLETED','OUT FOR DELIVERY']
              .includes(status);
          })
          .reverse();

        if (!myOrders.length) {
          container.innerHTML = '<p class="text-gray-500 text-center">No active orders found.</p>';
          return;
        }

        myOrders.forEach(order => {
          const indexInQueue = allOrders.findIndex(o => o.id === order.id);

          const validOrdersBefore = allOrders.slice(0, indexInQueue).filter(o => 
            !['DELIVERED','MILLING COMPLETED','OUT FOR DELIVERY','ARCHIVED']
            .includes(o.order_statuses?.status_name)
          );

          let totalKgBefore = 0;
          validOrdersBefore.forEach(o => {
            try { (o.grain_details || []).forEach(g => { totalKgBefore += Number(g.quantity || 0); }); }
            catch (e) { console.warn("Bad grain_details format", o.grain_details); }
          });

          let totalKgIncludingSelf = totalKgBefore;
          try { (order.grain_details || []).forEach(g => { totalKgIncludingSelf += Number(g.quantity || 0); }); }
          catch (e) { console.warn("Bad grain_details format", order.grain_details); }

          const timeInMinutes = Math.ceil(totalKgIncludingSelf * millingTimePerKg);
          const hours = Math.floor(timeInMinutes / 60);
          const minutes = timeInMinutes % 60;
          let estimatedTime;
          if (hours > 4 || (hours === 4 && minutes > 0)) estimatedTime = "4+ hrs";
          else estimatedTime = hours > 0 ? `${hours} hr ${minutes} min` : `${minutes} min`;

          const grainsHTML = (order.grain_details || []).map(g => `<li>${g.grain} - ${g.quantity} kg</li>`).join('');
          const date = window.convertUTCToIST ? window.convertUTCToIST(order.created_at) : new Date(order.created_at).toLocaleString();
          const statusLabel = order.order_statuses?.status_name || 'PENDING';
          const statusClass = getStatusClass(statusLabel);

          const card = document.createElement('div');
          card.className = 'bg-white shadow rounded-lg p-4';
          card.innerHTML = `
            <div class="flex justify-between items-start mb-2">
              <div>
                <p class="font-semibold text-gray-800">Token: ${order.token_number || 'N/A'}</p>
                <p class="text-sm text-gray-600">Date: ${date}</p>
              </div>
              <span class="px-2 py-1 text-xs rounded font-medium ${statusClass}">
                ${statusLabel}
              </span>
            </div>
            <ul class="list-disc ml-5 text-sm text-gray-700 mb-2">${grainsHTML}</ul>
            <p class="text-sm"><strong>Total:</strong> ₹${order.total_price?.toFixed(2) || 0}</p>
            ${statusLabel !== 'DELIVERED' ? `
              <p class="text-sm text-gray-600">Orders before you: ${validOrdersBefore.length}</p>
              <p class="text-sm text-gray-600">Estimated Time: ${estimatedTime}</p>
            ` : ''}
          `;
          container.appendChild(card);
        });
      }

      // Show toast if token present
      const token = new URLSearchParams(window.location.search).get("token");
      if (token) {
        const toast = document.getElementById("toast");
        toast.textContent = "✅ Order placed successfully! Token: " + token;
        toast.classList.remove("hidden");
        setTimeout(() => { toast.classList.add("hidden"); }, 3000);
      }

      // Kick off: load config, customer, orders
      (async () => {
        await fetchConfig();
        await fetchCustomer();
        if (user) loadOrders();
        window.loadOrders = loadOrders;
      })();

      // ---------- End original business logic ----------
    }
  </script>

</body>
</html>
