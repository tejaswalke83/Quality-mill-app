<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order Dashboard</title>

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f9fafb;
    }
  </style>
</head>
<body class="min-h-screen p-6">

  <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Order Dashboard</h1>

  <!-- Controls -->
  <div class="bg-white rounded-xl shadow p-4 mb-6 space-y-4">
    <!-- Search -->
    <div class="flex flex-wrap items-center gap-3">
      <input 
        type="text" 
        id="searchBox" 
        placeholder="🔍 Search by name, phone, token, total, status, grain..." 
        oninput="debouncedSearch()" 
        class="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
      />
      <button 
        onclick="resetSearch()" 
        class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 text-sm font-medium"
      >Reset</button>
    </div>

    <!-- Filter -->
    <div class="flex flex-wrap items-center gap-2 filter-group text-sm"></div>
  </div>

  <!-- Orders List -->
  <div id="ordersList" class="space-y-4"></div>

  <!-- Keep logic intact -->
  <script src="script.js"></script>
  <script type="module">
    window.updateOrderStatus = updateOrderStatus;
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://odczzymxgjsjhbufffxm.supabase.co';
    const supabaseKey = 'YOUR_SUPABASE_KEY';
    const supabase = createClient(supabaseUrl, supabaseKey);

    let searchTimeout;
    function debouncedSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        loadOrders();
      }, 300);
    }

    async function fetchAllOrders() {
      const { data, error } = await supabase
        .from('orders')
        .select(`
          *,
          customers(name, phone_number),
          order_statuses(status_name, sort_order, id)
        `)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Error fetching orders:', error);
        return [];
      }
      return data;
    }

    let statusesCache = [];
    async function fetchStatuses() {
      const { data, error } = await supabase
        .from('order_statuses')
        .select('*')
        .order('sort_order', { ascending: true });

      if (error) {
        console.error('Error fetching statuses:', error);
        return [];
      }
      statusesCache = data;
      return data;
    }

    // Build flows
    async function buildStatusFlows() {
      const { data: statuses, error } = await supabase
        .from('order_statuses')
        .select('*')
        .order('sort_order', { ascending: true });

      if (error) return {};

      statusesCache = statuses;
      const statusMap = {};
      statuses.forEach(s => statusMap[s.status_name] = s.id);

      return {
        "shop-milling": [statusMap["NEW"], statusMap["IN PROCESS"], statusMap["MILLING COMPLETED"], statusMap["DELIVERED"]],
        "shop-buy-mill": [statusMap["NEW"], statusMap["IN PROCESS"], statusMap["MILLING COMPLETED"], statusMap["DELIVERED"]],
        "home-milling": [statusMap["NEW"], statusMap["PICKED UP"], statusMap["RECEIVED AT MILL"], statusMap["IN PROCESS"], statusMap["MILLING COMPLETED"], statusMap["OUT FOR DELIVERY"], statusMap["DELIVERED"]],
        "home-buy-mill": [statusMap["NEW"], statusMap["IN PROCESS"], statusMap["MILLING COMPLETED"], statusMap["OUT FOR DELIVERY"], statusMap["DELIVERED"]]
      };
    }

    let statusFlows = {};
    async function initializeFlows() {
      statusFlows = await buildStatusFlows();
    }

    function getNextStatus(order) {
      const flow = statusFlows[order.order_type] || [];
      const currentStatusId = order.status_id;
      if (!currentStatusId) return null;

      const idx = flow.indexOf(currentStatusId);
      if (idx === -1 || idx + 1 >= flow.length) return null;

      const nextId = flow[idx + 1];
      return statusesCache.find(s => s.id === nextId);
    }

    await initializeFlows();

    async function updateOrderStatus(orderId, newStatusId) {
      const { error } = await supabase
        .from('orders')
        .update({ status_id: newStatusId })
        .eq('id', orderId);

      if (error) {
        alert('Failed to update status');
      } else {
        loadOrders();
      }
    }

    async function loadFilterButtons() {
      const statuses = await fetchStatuses();
      const filterGroup = document.querySelector('.filter-group');
      filterGroup.innerHTML = `
        <button class="filter-btn active px-3 py-1 rounded-md border text-gray-700 bg-gray-100" data-value="all">All</button>
      `;

      statuses.forEach(s => {
        filterGroup.innerHTML += `
          <button class="filter-btn px-3 py-1 rounded-md border text-gray-700 hover:bg-blue-50" data-value="${s.status_name}">
            ${s.status_name}
          </button>
        `;
      });

      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('bg-blue-500', 'text-white'));
          btn.classList.add('bg-blue-500', 'text-white');
          loadOrders();
        });
      });
    }

    async function loadOrders() {
      const allOrders = await fetchAllOrders();
      const activeFilterEl = document.querySelector('.filter-btn.active, .filter-btn.bg-blue-500');
      const activeFilter = activeFilterEl ? activeFilterEl.dataset.value : 'all';
      const searchTerm = document.getElementById('searchBox').value.toLowerCase();

      let filtered = allOrders;

      if (activeFilter !== 'all') {
        filtered = filtered.filter(o => o.order_statuses?.status_name === activeFilter);
      }

      if (searchTerm.trim() !== '') {
        filtered = filtered.filter(o =>
          (o.customers?.name?.toLowerCase() || '').includes(searchTerm) ||
          (o.customers?.phone_number || '').includes(searchTerm) ||
          (o.token_number?.toLowerCase() || '').includes(searchTerm) ||
          (o.total_price?.toString() || '').includes(searchTerm) ||
          (o.order_statuses?.status_name?.toLowerCase() || '').includes(searchTerm) ||
          (Array.isArray(o.grain_details) &&
            o.grain_details.some(g => (g.grain?.toLowerCase() || '').includes(searchTerm)))
        );
      }

      const container = document.getElementById('ordersList');
      container.innerHTML = '';

      if (filtered.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500">No orders found.</p>';
        return;
      }

      filtered.forEach(order => {
        let grainsHTML = '';
        const totalPrice = order.total_price || 0;

        if (order.grain_details && Array.isArray(order.grain_details)) {
          grainsHTML = '<ul class="list-disc ml-5 text-sm text-gray-600">' + order.grain_details.map(g =>
            `<li>${g.grain} - ${g.quantity} kg</li>`
          ).join('') + '</ul>';
        }

        const statusLabel = order.order_statuses?.status_name || "Unknown";
        const next = getNextStatus(order);

        const div = document.createElement('div');
        div.className = 'bg-white rounded-xl shadow-md p-4';
        div.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <h3 class="text-lg font-semibold text-gray-800">${order.customers?.name || 'N/A'}</h3>
            <div class="text-right text-sm text-gray-600">
              <div><strong>Token:</strong> ${order.token_number || ''}</div>
              <div><strong>Total:</strong> ₹${totalPrice.toFixed(2)}</div>
            </div>
          </div>
          <p class="text-sm text-gray-700"><strong>Phone:</strong> ${order.customers?.phone_number || 'N/A'}</p>
          <p class="text-sm text-gray-700"><strong>Created:</strong> ${window.convertUTCToIST(order.created_at)}</p>
          ${grainsHTML ? `<div class="mt-2"><strong class="text-sm text-gray-700">Grains:</strong> ${grainsHTML}</div>` : ''}
          <div class="flex justify-between items-center mt-4">
            <span class="px-2 py-1 text-xs rounded bg-gray-100 border">${statusLabel}</span>
            ${next 
              ? `<button onclick="updateOrderStatus('${order.id}', '${next.id}')" class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600">
                   Move to ${next.status_name}
                 </button>` 
              : ''
            }
          </div>
        `;
        container.appendChild(div);
      });
    }

    function resetSearch() {
      document.getElementById('searchBox').value = '';
      loadOrders();
    }

    window.debouncedSearch = debouncedSearch;
    window.loadOrders = loadOrders;
    window.resetSearch = resetSearch;

    loadFilterButtons();
    loadOrders();
  </script>
</body>
</html>
