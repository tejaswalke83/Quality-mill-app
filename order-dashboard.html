<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .search-group, .filter-group {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }

    .card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .card h3 {
      margin: 0 0 10px;
    }

    button {
      padding: 8px 12px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:disabled {
      background-color: gray;
    }
  </style>
</head>
<body>
  <h1>Order Dashboard</h1>

  <div class="controls">
    <div class="search-group">
      <input type="text" id="searchBox" placeholder="Search by name or phone" />
      <button onclick="resetSearch()">Reset</button>
    </div>

    <div class="filter-group">
      <label><strong>Filter by:</strong></label>
      <label><input type="radio" name="status" value="all" checked onchange="loadOrders()"> All</label>
      <label><input type="radio" name="status" value="new" onchange="loadOrders()"> New</label>
      <label><input type="radio" name="status" value="in_progress" onchange="loadOrders()"> In Progress</label>
      <label><input type="radio" name="status" value="milling_completed" onchange="loadOrders()"> Milling Completed</label>
      <label><input type="radio" name="status" value="delivered" onchange="loadOrders()"> Delivered</label>
    </div>
  </div>

  <div id="ordersList"></div>
<script src="script.js"></script>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

 const supabaseUrl = 'https://odczzymxgjsjhbufffxm.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kY3p6eW14Z2pzamhidWZmZnhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMjY2NDIsImV4cCI6MjA2OTkwMjY0Mn0.T2ZT6U11taDH7vNTUJgI9xvqEZ1YEfBrNx28QV7jJvI';
    const supabase = createClient(supabaseUrl, supabaseKey);

async function fetchStatuses() {
  const { data, error } = await supabase
    .from('order_statuses')
    .select('*')
    .order('status_name');

  if (error) {
    console.error('Error fetching statuses:', error);
    return [];
  }
  return data;
}

async function fetchAllOrders() {
  const { data, error } = await supabase
    .from('orders')
    .select('*, customers(name, phone_number)')
    .order('created_at', { ascending: false });

  if (error) {
    console.error('Error fetching orders:', error);
    return [];
  }

  return data;
}

function getNextStatus(currentStatus) {
  if (currentStatus === 'new') return 'in_progress';
  if (currentStatus === 'in_progress') return 'milling_completed';
  if (currentStatus === 'milling_completed') return 'delivered';
  return null;
}

function getStatusLabel(status) {
  if (status === 'new') return 'Mark In Progress';
  if (status === 'in_progress') return 'Milling Completed';
  if (status === 'milling_completed') return 'Delivery Completed';
  return '';
}

async function updateOrderStatus(orderId, newStatus) {
  const { error } = await supabase
    .from('orders')
    .update({ status: newStatus })
    .eq('id', orderId);

  if (error) {
    alert('Failed to update status');
    console.error(error);
  } else {
    loadOrders();
  }
}

async function loadFilterButtons() {
  const statuses = await fetchStatuses();
  const filterGroup = document.querySelector('.filter-group');
  filterGroup.innerHTML = `<label><strong>Filter by:</strong></label>
    <label><input type="radio" name="status" value="all" checked onchange="loadOrders()"> All</label>`;

  statuses.forEach(s => {
    filterGroup.innerHTML += `
      <label><input type="radio" name="status" value="${s.status_name}" onchange="loadOrders()"> ${s.status_name}</label>
    `;
  });
}

async function loadOrders() {
  const allOrders = await fetchAllOrders();

  const statusFilter = document.querySelector('input[name="status"]:checked').value;
  const searchTerm = document.getElementById('searchBox').value.toLowerCase();

  let filtered = allOrders;

  if (statusFilter !== 'all') {
    filtered = filtered.filter(o => o.status === statusFilter);
  }

  if (searchTerm.trim() !== '') {
    filtered = filtered.filter(o =>
      (o.customers?.name?.toLowerCase() || '').includes(searchTerm) ||
      (o.customers?.phone_number || '').includes(searchTerm)
    );
  }

  const container = document.getElementById('ordersList');
  container.innerHTML = '';

  if (filtered.length === 0) {
    container.innerHTML = '<p>No orders found.</p>';
    return;
  }

  filtered.forEach(order => {
    let grainsHTML = '';
    let totalPrice = order.total_price || 0;

    if (order.grain_details && Array.isArray(order.grain_details)) {
      grainsHTML = '<ul>' + order.grain_details.map(g =>
        `<li>${g.grain} - ${g.quantity} kg </li>`
      ).join('') + '</ul>';
    }

    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <h3>Token No: ${order.token_number}</h3>
      <p><strong>Name:</strong> ${order.customers?.name || 'N/A'}</p>
      <p><strong>Phone:</strong> ${order.customers?.phone_number || 'N/A'}</p>
      <p><strong>Status:</strong> ${order.status}</p>
      <p><strong>Created:</strong> ${window.convertUTCToIST(order.created_at)}</p>
      ${grainsHTML ? `<p><strong>Grains:</strong>${grainsHTML}</p>` : ''}
      <p><strong>Total Price:</strong> â‚¹${totalPrice.toFixed(2)}</p>
    `;

    const nextStatus = getNextStatus(order.status);
    if (nextStatus) {
      const btn = document.createElement('button');
      btn.textContent = getStatusLabel(order.status);
      btn.onclick = () => updateOrderStatus(order.id, nextStatus);
      div.appendChild(btn);
    }

    container.appendChild(div);
  });
}

function resetSearch() {
  document.getElementById('searchBox').value = '';
  loadOrders();
}

window.loadOrders = loadOrders;
window.resetSearch = resetSearch;

loadFilterButtons();
loadOrders();
</script>

  
<!--   <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://odczzymxgjsjhbufffxm.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kY3p6eW14Z2pzamhidWZmZnhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMjY2NDIsImV4cCI6MjA2OTkwMjY0Mn0.T2ZT6U11taDH7vNTUJgI9xvqEZ1YEfBrNx28QV7jJvI';
    const supabase = createClient(supabaseUrl, supabaseKey);

    async function fetchAllOrders() {
      const { data, error } = await supabase
        .from('orders')
        .select('*, customers(name, phone_number)')
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Error fetching orders:', error);
        return [];
      }

      return data;
    }

    function getNextStatus(currentStatus) {
      if (currentStatus === 'new') return 'in_progress';
      if (currentStatus === 'in_progress') return 'milling_completed';
      if (currentStatus === 'milling_completed') return 'delivered';
      return null;
    }

    function getStatusLabel(status) {
      if (status === 'new') return 'Mark In Progress';
      if (status === 'in_progress') return 'Milling Completed';
      if (status === 'milling_completed') return 'Delivery Completed';
      return '';
    }

    async function updateOrderStatus(orderId, newStatus) {
      const { error } = await supabase
        .from('orders')
        .update({ status: newStatus })
        .eq('id', orderId);

      if (error) {
        alert('Failed to update status');
        console.error(error);
      } else {
        loadOrders();
      }
    }

    async function loadOrders() {
      const allOrders = await fetchAllOrders();

      const statusFilter = document.querySelector('input[name="status"]:checked').value;
      const searchTerm = document.getElementById('searchBox').value.toLowerCase();

      let filtered = allOrders;

      if (statusFilter !== 'all') {
        filtered = filtered.filter(o => o.status === statusFilter);
      }

      if (searchTerm.trim() !== '') {
        filtered = filtered.filter(o =>
          (o.customers?.name?.toLowerCase() || '').includes(searchTerm) ||
          (o.customers?.phone || '').includes(searchTerm)
        );
      }

      const container = document.getElementById('ordersList');
      container.innerHTML = '';

      if (filtered.length === 0) {
        container.innerHTML = '<p>No orders found.</p>';
        return;
      }

      filtered.forEach(order => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <h3>Order #${order.token_number}</h3>
          <p><strong>Name:</strong> ${order.customers?.name || 'N/A'}</p>
          <p><strong>Phone:</strong> ${order.customers?.phone_number || 'N/A'}</p>
          <p><strong>Status:</strong> ${order.status}</p>
          <p><strong>Created:</strong> ${window.convertUTCToIST(order.created_at)}</p>
        `;

        const nextStatus = getNextStatus(order.status);
        if (nextStatus) {
          const btn = document.createElement('button');
          btn.textContent = getStatusLabel(order.status);
          btn.onclick = () => updateOrderStatus(order.id, nextStatus);
          div.appendChild(btn);
        }

        container.appendChild(div);
      });
    }

    function resetSearch() {
      document.getElementById('searchBox').value = '';
      loadOrders();
    }

    window.loadOrders = loadOrders;
    window.resetSearch = resetSearch;

    loadOrders();
  </script> -->
</body>
</html>
