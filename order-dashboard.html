<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .search-filter-bar {
      margin-bottom: 20px;
    }
    input[type="text"] {
      padding: 8px;
      width: 200px;
      margin-right: 10px;
    }
    button {
      padding: 8px 12px;
      margin-left: 5px;
    }
    .radio-group label {
      margin-right: 15px;
    }
    .card {
      border: 1px solid #ccc;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 2px 2px 5px #eee;
    }
    .card h3 {
      margin: 0 0 10px;
    }
    .status {
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h1>Order Dashboard</h1>

 <div class="search-filter-section">
    <div>
      <input type="text" id="searchInput" placeholder="Search by name or phone">
      <button onclick="resetSearch()">Reset</button>
    </div>

    <div class="filter-section">
      <span><strong>Filter by:</strong></span>
      <label><input type="radio" name="statusFilter" value="all" checked onchange="filterOrders()"> All</label>
      <label><input type="radio" name="statusFilter" value="new" onchange="filterOrders()"> New</label>
      <label><input type="radio" name="statusFilter" value="in_progress" onchange="filterOrders()"> In Progress</label>
      <label><input type="radio" name="statusFilter" value="milling_completed" onchange="filterOrders()"> Milling Completed</label>
      <label><input type="radio" name="statusFilter" value="delivered" onchange="filterOrders()"> Delivered</label>
    </div>
  </div>

  <div id="orderList"></div>

  <!-- Supabase CDN -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://odczzymxgjsjhbufffxm.supabase.co"; // ✅ Replace with your actual Supabase URL
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kY3p6eW14Z2pzamhidWZmZnhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMjY2NDIsImV4cCI6MjA2OTkwMjY0Mn0.T2ZT6U11taDH7vNTUJgI9xvqEZ1YEfBrNx28QV7jJvI"; // ✅ Replace with your actual anon key
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let allOrders = [];

    async function loadOrders() {
      const { data, error } = await supabase
        .from("orders")
        .select("*, customers(name, phone)");

      if (error) {
        console.error("Error loading orders:", error);
        return;
      }

      allOrders = data;
      displayOrders(data);
    }

    function displayOrders(orders) {
      const container = document.getElementById("orderList");
      container.innerHTML = "";

      if (orders.length === 0) {
        container.innerHTML = "<p>No orders found.</p>";
        return;
      }

      orders.forEach(order => {
        const card = document.createElement("div");
        card.className = "card";

        const customer = order.customers || {};
        const status = order.status;

        let nextAction = "";
        let nextStatus = "";

        if (status === "new") {
          nextAction = "Mark In Progress";
          nextStatus = "in_progress";
        } else if (status === "in_progress") {
          nextAction = "Milling Completed";
          nextStatus = "milling_completed";
        } else if (status === "milling_completed") {
          nextAction = "Delivery Completed";
          nextStatus = "delivered";
        }

        card.innerHTML = `
          <h3>${customer.name || "Unknown"} (${customer.phone || "-"})</h3>
          <p><strong>Token:</strong> ${order.token_number}</p>
          <p><strong>Status:</strong> <span class="status">${status.replace("_", " ").toUpperCase()}</span></p>
          <p><strong>Created:</strong> ${new Date(order.created_at).toLocaleString()}</p>
          ${nextAction ? `<button onclick="updateOrderStatus('${order.id}', '${nextStatus}')">${nextAction}</button>` : ""}
        `;

        container.appendChild(card);
      });
    }

    async function updateOrderStatus(orderId, newStatus) {
      const { error } = await supabase
        .from("orders")
        .update({ status: newStatus })
        .eq("id", orderId);

      if (error) {
        alert("Failed to update status");
        console.error(error);
      } else {
        loadOrders();
      }
    }

    function applyFilters() {
      const searchText = document.getElementById("searchInput").value.trim().toLowerCase();
      const selectedStatus = document.querySelector('input[name="statusFilter"]:checked').value;

      let filtered = allOrders;

      if (searchText !== "") {
        filtered = filtered.filter(o => {
          const name = o.customers?.name?.toLowerCase() || "";
          const phone = o.customers?.phone || "";
          return name.includes(searchText) || phone.includes(searchText);
        });
      }

      if (selectedStatus !== "all") {
        filtered = filtered.filter(o => o.status === selectedStatus);
      }

      displayOrders(filtered);
    }

    function resetSearch() {
      document.getElementById("searchInput").value = "";
      document.querySelector('input[value="all"]').checked = true;
      displayOrders(allOrders);
    }

    // Initial load
    loadOrders();
  </script>

</body>
</html>
