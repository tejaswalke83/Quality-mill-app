<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .search-group, .filter-group {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }

    .card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .card h3 {
      margin: 0 0 10px;
    }

    button {
      padding: 8px 12px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:disabled {
      background-color: gray;
    }
    .filter-btn {
    border: 1px solid #ccc;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    background-color: #f9f9f9;
    font-size: 14px;
  }
  .filter-btn.active {
    background-color: #007bff;
    color: #fff;
    border-color: #007bff;
  }
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
  }
  .card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
  }
  </style>
</head>
<body>
  <h1>Order Dashboard</h1>

  <div class="controls">
   <div class="search-group">
  <input 
    type="text" 
    id="searchBox" 
    placeholder="Search by name, phone, token, total, status, grain..." 
    oninput="debouncedSearch()" 
  />
  <button onclick="resetSearch()">Reset</button>
</div>



    <div class="filter-group">
      <label><strong>Filter by:</strong></label>
      <label><input type="radio" name="status" value="all" checked onchange="loadOrders()"> All</label>
      <label><input type="radio" name="status" value="new" onchange="loadOrders()"> New</label>
      <label><input type="radio" name="status" value="in_progress" onchange="loadOrders()"> In Progress</label>
      <label><input type="radio" name="status" value="milling_completed" onchange="loadOrders()"> Milling Completed</label>
      <label><input type="radio" name="status" value="delivered" onchange="loadOrders()"> Delivered</label>
    </div>
  </div>

  <div id="ordersList"></div>
<script src="script.js"></script>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

 const supabaseUrl = 'https://odczzymxgjsjhbufffxm.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kY3p6eW14Z2pzamhidWZmZnhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMjY2NDIsImV4cCI6MjA2OTkwMjY0Mn0.T2ZT6U11taDH7vNTUJgI9xvqEZ1YEfBrNx28QV7jJvI';
    const supabase = createClient(supabaseUrl, supabaseKey);

let searchTimeout;
function debouncedSearch() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    loadOrders();
  }, 300); // 300ms debounce
}


async function fetchAllOrders() {
  const { data, error } = await supabase
    .from('orders')
    .select('*, customers(name, phone_number)')
    .order('created_at', { ascending: false });

  if (error) {
    console.error('Error fetching orders:', error);
    return [];
  }

  return data;
}

// Define status flows
const statusFlows = {
  shop_milling:    [1, 4, 5, 7],
  shop_buy_mill:   [1, 4, 5, 7],
  home_milling:    [1, 2, 3, 4, 5, 6, 7],
  home_buy_mill:   [1, 2, 3, 4, 5, 6, 7]
};

let statusesCache = []; // cache statuses for labels

async function fetchStatuses() {
  const { data, error } = await supabase
    .from('order_statuses')
    .select('*')
    .order('sort_order', { ascending: true });

  if (error) {
    console.error('Error fetching statuses:', error);
    return [];
  }
  statusesCache = data;
  return data;
}

// Get next status id for this order
function getNextStatus(order) {
  const flow = statusFlows[order.order_type] || [];
  const currentStatus = statusesCache.find(s => s.status_name.toLowerCase() === order.status.toLowerCase());
  if (!currentStatus) return null;

  const idx = flow.indexOf(currentStatus.sort_order);
  if (idx === -1 || idx + 1 >= flow.length) return null;

  const nextSortOrder = flow[idx + 1];
  return statusesCache.find(s => s.sort_order === nextSortOrder);
}


async function updateOrderStatus(orderId, newStatus) {
  const { error } = await supabase
    .from('orders')
    .update({ status: newStatus })
    .eq('id', orderId);

  if (error) {
    alert('Failed to update status');
    console.error(error);
  } else {
    loadOrders();
  }
}



 async function fetchStatuses() {
  const { data, error } = await supabase
    .from('order_statuses')
    .select('*')
    .order('sort_order', { ascending: true }); // ✅ sort by DB column

  if (error) {
    console.error('Error fetching statuses:', error);
    return [];
  }
  return data;
}

async function loadFilterButtons() {
  const statuses = await fetchStatuses();
  const filterGroup = document.querySelector('.filter-group');
  filterGroup.innerHTML = `<label><strong>Filter by:</strong></label>
    <button class="filter-btn active" data-value="all">All</button>`;

  statuses.forEach(s => {
    filterGroup.innerHTML += `
      <button class="filter-btn" data-value="${s.status_name}">${s.status_name}</button>
    `;
  });

  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      loadOrders();
    });
  });
} 

async function loadOrders() {
  const allOrders = await fetchAllOrders();

  const activeFilterEl = document.querySelector('.filter-btn.active');
  const activeFilter = activeFilterEl ? activeFilterEl.dataset.value : 'all'; // default to 'all'

  const searchTerm = document.getElementById('searchBox').value.toLowerCase();

  let filtered = allOrders;

  if (activeFilter !== 'all') {
    filtered = filtered.filter(o => o.status === activeFilter);
  }

  // if (searchTerm.trim() !== '') {
  //   filtered = filtered.filter(o =>
  //     (o.customers?.name?.toLowerCase() || '').includes(searchTerm) ||
  //     (o.customers?.phone_number || '').includes(searchTerm)
  //   );
  // }

  if (searchTerm.trim() !== '') {
  filtered = filtered.filter(o =>
    (o.customers?.name?.toLowerCase() || '').includes(searchTerm) ||
    (o.customers?.phone_number || '').includes(searchTerm) ||
    (o.token_number?.toLowerCase() || '').includes(searchTerm) ||
    (o.total_price?.toString() || '').includes(searchTerm) ||
    (o.status?.toLowerCase() || '').includes(searchTerm) ||
    // search inside grain_details (array of objects)
    (Array.isArray(o.grain_details) &&
      o.grain_details.some(g =>
        (g.grain?.toLowerCase() || '').includes(searchTerm)
      ))
  );
  }

 
  const container = document.getElementById('ordersList');
  container.innerHTML = '';

  if (filtered.length === 0) {
    container.innerHTML = '<p>No orders found.</p>';
    return;
  }

  filtered.forEach(order => {
    let grainsHTML = '';
    let totalPrice = order.total_price || 0;

    if (order.grain_details && Array.isArray(order.grain_details)) {
      grainsHTML = '<ul>' + order.grain_details.map(g =>
        `<li>${g.grain} - ${g.quantity} kg</li>`
      ).join('') + '</ul>';
    }

    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <div class="card-header">
        <h3>${order.customers?.name || 'N/A'}</h3>
        <div style="text-align:right">
          <strong>Token:</strong> ${order.token_number || ''}<br>
          <strong>Total:</strong> ₹${totalPrice.toFixed(2)}
        </div>
      </div>
      <p><strong>Phone:</strong> ${order.customers?.phone_number || 'N/A'}</p>
      <p><strong>Created:</strong> ${window.convertUTCToIST(order.created_at)}</p>
      ${grainsHTML ? `<p><strong>Grains:</strong>${grainsHTML}</p>` : ''}
      <div class="card-footer">
       <span><strong>Status:</strong> ${order.status}</span>
${(() => {
   const next = getNextStatus(order);
   return next 
     ? `<button onclick="updateOrderStatus('${order.id}', '${next.status_name}')">
          Move to ${next.status_name}
        </button>` 
     : '';
 })()}

      </div>
    `;

    container.appendChild(div);
  });
}

function resetSearch() {
  document.getElementById('searchBox').value = '';
  loadOrders();
}
window.debouncedSearch = debouncedSearch;
window.loadOrders = loadOrders;
window.resetSearch = resetSearch;

loadFilterButtons();
loadOrders();
</script>

  
</body>
</html>
