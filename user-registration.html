<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Registration</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f5f5f5;
      padding: 30px;
    }
    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-container {
      background: #fff;
      padding: 25px 30px;
      border-radius: 12px;
      max-width: 500px;
      margin: auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    label {
      font-weight: 500;
      display: block;
      margin-bottom: 6px;
    }
    input {
      width: 100%;
      padding: 10px 12px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0,123,255,0.2);
    }
    .error {
      color: red;
      font-size: 13px;
      margin-top: 5px;
    }
    .inline-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .inline-group input {
      flex: 1;
    }
    button {
      padding: 10px 16px;
      font-size: 1rem;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #0056b3;
    }
    .hidden {
      display: none;
    }
    #status {
      margin-top: 10px;
      text-align: center;
      font-weight: 500;
    }
    /* Radio buttons inline */
    .radio-group {
      display: flex;
      gap: 15px;
      margin-top: 6px;
    }
    .radio-group label {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 0;
      font-weight: normal;
    }
    /* Typeahead dropdown */
    .suggestions {
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-top: 4px;
      max-height: 120px;
      overflow-y: auto;
      background: #fff;
      position: absolute;
      z-index: 10;
      width: 100%;
    }
    .suggestion {
      padding: 8px 10px;
      cursor: pointer;
    }
    .suggestion:hover {
      background: #f0f0f0;
    }
    /* Advertisement */
    #advertisement {
      margin: 30px auto;
      max-width: 500px;
      text-align: center;
      background: #fff;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      color: #555;
    }
  </style>

  <!-- <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#007bff">
  <link rel="icon" href="/icons/icon-192.png" sizes="192x192"> -->
  <script defer src="/common.js"></script>
</head>
<body>

  <h2>Start Here</h2>

  <div class="form-container">

    <!-- Mobile number input -->
    <div id="mobile-section" class="form-group">
      <label for="mobile">Mobile Number</label>
      <div class="inline-group">
        <input type="tel" id="mobile" placeholder="Enter 10-digit mobile number" />
        <button onclick="checkUser()">Proceed</button>
      </div>
      <div id="mobile-error" class="error"></div>
    </div>

    <!-- Staff password input -->
    <div id="staff-password-section" class="form-group hidden">
      <label for="staff-password">Enter Password</label>
      <div class="inline-group">
        <input type="password" id="staff-password" placeholder="Enter your password" />
        <button onclick="verifyStaffPassword()">Login</button>
      </div>
      <div id="password-error" class="error"></div>
    </div>

    <!-- Registration form -->
    <div id="register-section" class="hidden">

      <p id="new-user-msg" class="text-blue-600 font-medium mb-4">New user. Please register.</p>

      <div class="form-group">
        <label for="name">Full Name</label>
        <input type="text" id="name" placeholder="Enter full name" />
        <div id="name-error" class="error"></div>
      </div>

      <!-- Society with typeahead -->
      <div class="form-group" style="position: relative;">
        <label for="society-input">Society</label>
        <input type="text" id="society-input" placeholder="Search or type society name" autocomplete="off" />
        <div id="society-suggestions" class="suggestions hidden"></div>
        <div id="society-error" class="error"></div>
      </div>

      <div class="form-group">
        <label for="wing">Wing</label>
        <input type="text" id="wing" placeholder="Enter wing" />
        <div id="wing-error" class="error"></div>
      </div>

      <div class="form-group">
        <label for="flat">Flat Number</label>
        <input type="text" id="flat" placeholder="Enter flat number" />
        <div id="flat-error" class="error"></div>
      </div>

      <div class="form-group">
        <label>Milling Preference</label>
        <div class="radio-group">
          <label><input type="radio" name="milling" value="fine" /> Fine</label>
          <label><input type="radio" name="milling" value="medium" /> Medium</label>
          <label><input type="radio" name="milling" value="coarse" /> Coarse</label>
        </div>
        <div id="milling-error" class="error"></div>
      </div>

      <button onclick="registerUser()">Register</button>
    </div>

    <div id="status" class="form-group"></div>
  </div>

  <!-- Advertisement at bottom -->
  <div id="advertisement">
    <h3>ðŸŒ¾ Quality Atta Mills </h3>
    <p>Fast, fresh, and healthy flour</p>
    <img src="https://via.placeholder.com/400x200?text=Your+Ad+Here" alt="Ad" style="width:100%; border-radius:8px; margin-top:15px;">
  </div>

  <!-- Supabase and JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Load environment config -->
<script src="/config.js"></script>
  <script>
     // âœ… Read Supabase credentials from config.js (populated by Netlify)
  const SUPABASE_URL = window._env_.SUPABASE_URL;
  const SUPABASE_KEY = window._env_.SUPABASE_ANON_KEY;
  
  // âœ… Create Supabase client
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let societiesCache = [];

    // âœ… Check user flow
    window.checkUser = async function() {
      const mobile = document.getElementById('mobile').value.trim();
      clearErrors();

      if (!/^\d{10}$/.test(mobile)) {
        document.getElementById('mobile-error').innerText = "Enter a valid 10-digit mobile number.";
        return;
      }
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.getRegistrations().then(registrations => {
    for (let reg of registrations) {
      console.log("ðŸ§¹ Unregistering old service worker:", reg.scope);
      reg.unregister();
    }
  });
}
      document.getElementById('status').innerText = "Checking user...";

      try {
        const { data: userData } = await supabase.from('users').select('*').eq('phone_number', mobile).maybeSingle();
        if (userData && ['admin','manager','operator','delivery'].includes(userData.role)) {
          document.getElementById('staff-password-section').classList.remove('hidden');
          document.getElementById('mobile-section').classList.add('hidden');
          document.getElementById('status').innerText = "Staff Login. Please enter your password.";
          window.currentStaffUser = userData;
          return;
        }

        const { data: customerData } = await supabase.from('customers').select('*').eq('phone_number', mobile).maybeSingle();
        if (customerData) {
          document.getElementById('status').innerText = "User found. Redirecting...";
// Save FCM token to Supabase when existing user logs in
  if (window.saveFcmTokenToSupabase) {
    await window.saveFcmTokenToSupabase(mobile);
  }

          setTimeout(() => {
            window.location.href = `my-orders.html?phone=${mobile}`;
          }, 1000);
        } else {
          // New user
          document.getElementById('status').innerText = "";
          document.getElementById('register-section').classList.remove('hidden');
          document.getElementById('advertisement').classList.add('hidden');
          loadSocieties();
        }
      } catch (err) {
        console.error('Error checking user:', err);
        alert("Something went wrong. Please try again.");
        document.getElementById('status').innerText = "";
      }
    };

    // âœ… Verify staff login
    window.verifyStaffPassword = async function() {
    const passwordInput = document.getElementById('staff-password').value;
    const staffUser = window.currentStaffUser;
    document.getElementById('password-error').innerText = "";

    if (!passwordInput) {
      document.getElementById('password-error').innerText = "Password cannot be empty.";
      return;
    }

    if (passwordInput === staffUser.password) {
      document.getElementById('status').innerText = "Login successful! Redirecting...";
      setTimeout(() => {
        if (staffUser.role && staffUser.role.toLowerCase() === "admin") {
          // âœ… Admin login â†’ Admin.html
          window.location.href = `Admin.html?phone=${staffUser.phone_number}`;
        } else if (staffUser.role && staffUser.role.toLowerCase() === "manager") {
          // âœ… Manager login â†’ order-dashboard.html
          window.location.href = `order-dashboard.html?phone=${staffUser.phone_number}`;
        } else {
          // âœ… Other staff roles (operator, delivery, etc.)
          window.location.href = `order-dashboard.html?phone=${staffUser.phone_number}`;
        }
      }, 1000);
    } else {
      document.getElementById('password-error').innerText = "Incorrect password.";
    }
  };

    // âœ… Societies typeahead
    async function loadSocieties() {
      try {
        const { data } = await supabase.from('societies').select('*');
        societiesCache = data || [];

        const input = document.getElementById('society-input');
        const suggestions = document.getElementById('society-suggestions');

        input.addEventListener('input', () => {
          const val = input.value.toLowerCase();
          suggestions.innerHTML = '';
          if (!val) {
            suggestions.classList.add('hidden');
            return;
          }
          let matches = societiesCache.filter(s => s.name.toLowerCase().includes(val));
          matches.forEach(soc => {
            const div = document.createElement('div');
            div.className = 'suggestion';
            div.textContent = soc.name;
            div.onclick = () => {
              input.value = soc.name;
              suggestions.innerHTML = '';
              suggestions.classList.add('hidden');
            };
            suggestions.appendChild(div);
          });
          if (matches.length > 0) {
            suggestions.classList.remove('hidden');
          } else {
            suggestions.classList.add('hidden');
          }
        });
      } catch (err) {
        console.error('Error loading societies:', err);
      }
    }

    // âœ… Register user
    window.registerUser = async function() {
      const phoneNumber = document.getElementById('mobile').value.trim();
      const name = document.getElementById('name').value.trim();
      const societyName = document.getElementById('society-input').value.trim();
      const wing = document.getElementById('wing').value.trim();
      const flatNumber = document.getElementById('flat').value.trim();
      const millingPreference = document.querySelector('input[name="milling"]:checked')?.value || '';

      clearErrors();

      if (!phoneNumber || !name || !societyName || !wing || !flatNumber || !millingPreference) {
        showError("Please fill in all required fields.");
        return;
      }

      try {
        // âœ… Check if society exists
        let { data: existingSoc } = await supabase.from('societies').select('*').eq('name', societyName).maybeSingle();

        if (!existingSoc) {
          // Insert new society if not found
          const { data: newSoc, error: insertError } = await supabase.from('societies').insert([{ name: societyName }]).select().single();
          if (insertError) {
            console.error("Error inserting new society:", insertError);
          } else {
            existingSoc = newSoc;
          }
        }

        // âœ… Insert new customer
        const { error } = await supabase.from('customers').insert([{
          phone_number: phoneNumber,
          name: name,
          society_name: societyName,
          society_id: existingSoc?.id || null,
          flat_number: flatNumber,
          wing: wing,
          milling_preference: millingPreference
        }]);

        if (error) {
          showError("Error registering user. Please try again.");
          return;
        }

        alert("User registered successfully!");
        document.getElementById('status').innerText = "Redirecting...";
// Save FCM token to Supabase for new user
if (window.saveFcmTokenToSupabase) {
  await window.saveFcmTokenToSupabase(phoneNumber);
}

        window.location.href = `select-order-type.html?phone=${phoneNumber}`;
      } catch (err) {
        console.error("Error registering user:", err);
        showError("Unexpected error. Please try again.");
      }
    };

    function showError(msg) {
      document.getElementById('status').innerText = msg;
    }

    function clearErrors() {
      ['mobile-error','name-error','society-error','wing-error','flat-error','milling-error']
        .forEach(id => document.getElementById(id).innerText = '');
      document.getElementById('status').innerText = "";
    }
  </script>
</body>
</html>
