
   
 
   
 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Registration</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    .hidden { display: none; }
    .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #ccc; border-top: 3px solid #333; border-radius: 50%; animation: spin 1s linear infinite; vertical-align: middle; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .error { color: red; font-size: 13px; }
    .field { margin-bottom: 12px; }
  </style>
</head>
<body>


   
<h2>User Registration</h2>

<div id="step1">
  <div class="field">
    <label for="mobile">Enter Mobile Number:</label><br>
    <input type="text" id="mobile" />
    <div id="mobile-error" class="error"></div>
  </div>
  <button id="check-btn">➡️</button>
  <div id="spinner1" class="spinner hidden"></div>
</div>

<div id="step2" class="hidden">
  <div class="field">
    <label>Name:</label><br>
    <input type="text" id="name" />
    <div id="name-error" class="error"></div>
  </div>

  <div class="field">
    <label>Society:</label><br>
    <select id="society-dropdown"></select>
    <div id="society-error" class="error"></div>
  </div>

  <div class="field">
    <label>Flat Number:</label><br>
    <input type="text" id="flat" />
    <div id="flat-error" class="error"></div>
  </div>

  <div class="field">
    <label>Wing:</label><br>
    <input type="text" id="wing" />
    <div id="wing-error" class="error"></div>
  </div>

  <button id="register-btn">Register</button>
  <div id="spinner2" class="spinner hidden"></div>
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const supabaseUrl = 'https://odczzymxgjsjhbufffxm.supabase.com';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kY3p6eW14Z2pzamhidWZmZnhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMjY2NDIsImV4cCI6MjA2OTkwMjY0Mn0.T2ZT6U11taDH7vNTUJgI9xvqEZ1YEfBrNx28QV7jJvI';
  const supabase = createClient(supabaseUrl, supabaseKey);

  const checkBtn = document.getElementById("check-btn");
  const spinner1 = document.getElementById("spinner1");
  const spinner2 = document.getElementById("spinner2");

  const mobileInput = document.getElementById("mobile");
  const nameInput = document.getElementById("name");
  const societyDropdown = document.getElementById("society-dropdown");
  const flatInput = document.getElementById("flat");
  const wingInput = document.getElementById("wing");

  function clearErrors() {
    document.querySelectorAll('.error').forEach(e => e.textContent = '');
  }

  function validateMobile() {
    const mobile = mobileInput.value.trim();
    if (!/^\d{10}$/.test(mobile)) {
      document.getElementById("mobile-error").textContent = "Enter valid 10-digit number";
      return false;
    }
    return true;
  }

  function validateForm() {
    let valid = true;
    clearErrors();

    if (nameInput.value.trim() === '') {
      document.getElementById("name-error").textContent = "Name is required";
      valid = false;
    }

    if (!societyDropdown.value) {
      document.getElementById("society-error").textContent = "Select a society";
      valid = false;
    }

    if (flatInput.value.trim() === '') {
      document.getElementById("flat-error").textContent = "Flat number required";
      valid = false;
    }

    if (wingInput.value.trim() === '') {
      document.getElementById("wing-error").textContent = "Wing is required";
      valid = false;
    }

    return valid;
  }

  async function loadSocieties() {
    const { data, error } = await supabase.from("societies").select("*");
    if (error) {
      alert("Error fetching societies");
      return;
    }
    societyDropdown.innerHTML = `<option value="">-- Select --</option>`;
    data.forEach(society => {
      const opt = document.createElement("option");
      opt.value = society.society_name;
      opt.textContent = society.society_name;
      societyDropdown.appendChild(opt);
    });
  }

  checkBtn.addEventListener("click", async () => {
    clearErrors();
    if (!validateMobile()) return;

    spinner1.classList.remove("hidden");

    try {
      const { data, error } = await supabase
        .from("customers")
        .select("id")
        .eq("phone_number", mobileInput.value.trim())

          alert("customers " + data);
        .single();

      spinner1.classList.add("hidden");

      if (data) {
        alert("User already registered.");
        // redirect to order page if needed
        // window.location.href = "place-order.html?mobile=" + mobileInput.value.trim();
      } else {
        document.getElementById("step2").classList.remove("hidden");
        loadSocieties();
      }

    } catch (e) {
      spinner1.classList.add("hidden");
      alert("Error checking mobile: " + e.message);
    }
  });

  document.getElementById("register-btn").addEventListener("click", async () => {
    if (!validateForm()) return;

    spinner2.classList.remove("hidden");

    try {
      const { error } = await supabase.from("customers").insert([{
        phone_number: mobileInput.value.trim(),
        name: nameInput.value.trim(),
        society_name: societyDropdown.value,
        flat_number: flatInput.value.trim(),
        wing: wingInput.value.trim(),
        city: 'YourCity',
        area: 'YourArea'
      }]);

      spinner2.classList.add("hidden");

      if (error) throw error;

      alert("User registered successfully!");
      window.location.href = "place-order.html?mobile=" + mobileInput.value.trim();

    } catch (e) {
      spinner2.classList.add("hidden");
      alert("Registration error: " + e.message);
    }
  });
</script>

</body>
</html>
