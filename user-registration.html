<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Registration</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f5f5f5;
      padding: 30px;
    }
    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-container {
      background: #fff;
      padding: 25px 30px;
      border-radius: 12px;
      max-width: 500px;
      margin: auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    label {
      font-weight: 500;
      display: block;
      margin-bottom: 6px;
    }
    input, select {
      width: 100%;
      padding: 10px 12px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0,123,255,0.2);
    }
    .error {
      color: red;
      font-size: 13px;
      margin-top: 5px;
    }
    .inline-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .inline-group input {
      flex: 1;
    }
    button {
      padding: 10px 16px;
      font-size: 1rem;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #0056b3;
    }
    .hidden {
      display: none;
    }
    #status {
      margin-top: 20px;
      text-align: center;
      font-weight: 500;
    }
  </style>
</head>
<body>

  <h2>User Registration</h2>

  <div class="form-container">

    <!-- Mobile number input -->
    <div id="mobile-section" class="form-group">
      <label for="mobile">Mobile Number</label>
      <div class="inline-group">
        <input type="tel" id="mobile" placeholder="Enter 10-digit mobile number" />
        <button onclick="checkUser()">Proceed</button>
      </div>
      <div id="mobile-error" class="error"></div>
    </div>

    <!-- Registration form (hidden by default) -->
    <div id="register-section" class="hidden">
      <div class="form-group">
        <label for="name">Full Name</label>
        <input type="text" id="name" placeholder="Enter full name" />
        <div id="name-error" class="error"></div>
      </div>

      <div class="form-group">
        <label for="society">Society</label>
        <select id="society">
          <option value="">Select</option>
        </select>
        <div id="society-error" class="error"></div>
      </div>

      <div class="form-group">
        <label for="wing">Wing</label>
        <input type="text" id="wing" placeholder="Enter wing" />
        <div id="wing-error" class="error"></div>
      </div>

      <div class="form-group">
        <label for="flat">Flat Number</label>
        <input type="text" id="flat" placeholder="Enter flat number" />
        <div id="flat-error" class="error"></div>
      </div>

    <div class="form-group">
  <label>Milling Preference</label><br/>
  <label><input type="radio" name="milling" value="fine" /> Fine</label><br/>
  <label><input type="radio" name="milling" value="medium" /> Medium</label><br/>
  <label><input type="radio" name="milling" value="coarse" /> Coarse</label>
  <div id="milling-error" class="error"></div>
</div>


      <button onclick="registerUser()">Register</button>
    </div>

    <!-- Output -->
    <div id="status" class="form-group"></div>

  </div>

  <!-- Supabase and JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>

    document.getElementById('register-section').classList.add('hidden');

    const SUPABASE_URL = 'https://odczzymxgjsjhbufffxm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kY3p6eW14Z2pzamhidWZmZnhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMjY2NDIsImV4cCI6MjA2OTkwMjY0Mn0.T2ZT6U11taDH7vNTUJgI9xvqEZ1YEfBrNx28QV7jJvI';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);


async function checkUser() {
  const mobile = document.getElementById('mobile').value.trim();
  clearErrors();
  
  if (!/^\d{10}$/.test(mobile)) {
    document.getElementById('mobile-error').innerText = "Enter a valid 10-digit mobile number.";
    return;
  }

  document.getElementById('status').innerText = "Checking user...";

  try {
    console.log('Checking mobile number:', mobile, '| Type:', typeof mobile);

    const { data, error } = await supabase
      .from('customers')
      .select('*')
      .eq('phone_number', mobile)  // or Number(mobile) if your DB uses numbers
      .maybeSingle();

    console.log('Supabase query result:', data);
    console.log('Supabase query error:', error);

    const { data: data1, error: error1 } = await supabase
      .from('customers')
      .select('*');

    console.log('All customers:', data1);
    console.log('Error fetching all customers:', error1);

    if (error) throw error;

    if (data) {
      document.getElementById('status').innerText = "User found. Redirecting...";
      setTimeout(() => {
        window.location.href = `create-order.html?phone=${mobile}`;
      }, 1000);
    } else {
      document.getElementById('status').innerText = "New user. Please register.";
      document.getElementById('register-section').classList.remove('hidden');
      loadSocieties();
    }
  } catch (err) {
    console.error('Error checking user:', err);
    alert("Something went wrong while checking the user. Please try again.");
    document.getElementById('status').innerText = "";
  }
}







    

// async function checkUser() {
//   const mobile = document.getElementById('mobile').value.trim();
//   clearErrors();
//   if (!/^\d{10}$/.test(mobile)) {
//     document.getElementById('mobile-error').innerText = "Enter a valid 10-digit mobile number.";
//     return;
//   }

//   document.getElementById('status').innerText = "Checking user...";

//   try {
//     console.log('Checking mobile number:', mobile);

//     const { data, error } = await supabase
//       .from('customers')
//       .select('*')
//       .eq('phone_number', mobile)
//       .maybeSingle();
    
//     console.log('Checking data from db:', data);

//     const { data1, error1 } = await supabase
//   .from('customers')
//   .select('*');

// console.log('All customers:', data1);

//     if (error) throw error;

//     if (data) {
//       // âœ… User exists, redirect to create order page
//       document.getElementById('status').innerText = "User found. Redirecting...";
//       // You can also pass the phone number or user id via URL if needed
//       setTimeout(() => {
//         window.location.href = `create-order.html?phone=${mobile}`;
//       }, 1000);
//     } else {
//       // ðŸ†• User, show registration
//       document.getElementById('status').innerText = "New user. Please register.";
//       document.getElementById('register-section').classList.remove('hidden');
//       loadSocieties();
//     }
//   } catch (err) {
//     console.error('Error checking user:', err);
//     alert("Something went wrong while checking the user. Please try again.");
//     document.getElementById('status').innerText = "";
//   }
// }



    
    // async function checkUser() {
    //   const mobile = document.getElementById('mobile').value.trim();
    //   clearErrors();
    //   if (!/^\d{10}$/.test(mobile)) {
    //     document.getElementById('mobile-error').innerText = "Enter a valid 10-digit mobile number.";
    //     return;
    //   }

    //   document.getElementById('status').innerText = "Checking user...";
    //   try {
    //     const { data, error } = await supabase
    //       .from('customers')
    //       .select('*')
    //       .eq('phone_number', mobile)
    //       .maybeSingle();

    //     if (error) throw error;

    //     if (data) {
    //       document.getElementById('status').innerText = "User already exists.";
    //     } else {
    //       document.getElementById('status').innerText = "New user. Please register.";
    //       document.getElementById('register-section').classList.remove('hidden');
    //       loadSocieties();
    //     }
    //   } catch (err) {
    //     console.error('Error checking user:', err);
    //     alert("Something went wrong while checking the user. Please try again.");
    //     document.getElementById('status').innerText = "";
    //   }
    // }

    async function loadSocieties() {
      try {
        const { data, error } = await supabase
          .from('societies')
          .select('*');

        if (error) throw error;

        const dropdown = document.getElementById('society');
        dropdown.innerHTML = '<option value="">Select</option>';
        data.forEach(soc => {
          const opt = document.createElement('option');
          opt.value = soc.id;
          opt.text = soc.name;
          dropdown.appendChild(opt);
        });
      } catch (err) {
        console.error('Error loading societies:', err);
        alert("Error loading societies. Check console for details.");
      }
    }

    async function registerUser() {
      const phoneNumber = document.getElementById('mobile').value.trim();
      const name = document.getElementById('name').value.trim();
      const societyId = document.getElementById('society').value;
      const flatNumber = document.getElementById('flat').value.trim();
      const wing = document.getElementById('wing').value.trim();
      const millingPreference = document.querySelector('input[name="milling"]:checked')?.value || '';


      clearErrors();

      if (!phoneNumber || !name || !societyId || !flatNumber || !wing || !millingPreference) {
        showError("Please fill in all required fields.");
        return;
      }

      try {
        const { data: societyData, error: societyFetchError } = await supabase
          .from('societies')
          .select('name')
          .eq('id', societyId)
          .single();

        if (societyFetchError || !societyData) {
          console.error("Error fetching society name:", societyFetchError);
          showError("Failed to fetch society details.");
          return;
        }

        const societyName = societyData.name;

        const { error } = await supabase.from('customers').insert([{
          phone_number: phoneNumber,
          name: name,
          society_id: societyId,
          society_name: societyName,
          flat_number: flatNumber,
          wing: wing,
          milling_preference: millingPreference
        }]);

        if (error) {
          console.error("Error registering user: ", error);
          showError("Error registering user. Please try again.");
          return;
        }

        alert("User registered successfully!");
        location.reload();
      } catch (err) {
        console.error("Unexpected error during registration:", err);
        showError("Unexpected error. Please try again.");
      }
    }

    function showError(msg) {
      document.getElementById('status').innerText = msg;
    }

    function clearErrors() {
      ['mobile-error', 'name-error', 'society-error', 'wing-error', 'flat-error', 'milling-error']
        .forEach(id => document.getElementById(id).innerText = '');
      document.getElementById('status').innerText = "";
    }
  </script>
</body>
</html>
