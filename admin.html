<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* small visual tweaks for the status badges inside cards */
    .status-badge { @apply inline-block px-2 py-1 rounded-full text-xs font-semibold; }
    /* tiny timestamp */
    .refresh-meta { font-size: 12px; color: #6b7280; } /* text-gray-500 */
  </style>
</head>
<body class="h-screen flex bg-gray-100">

  <!-- Sidebar -->
  <aside class="w-64 bg-white shadow-md">
    <div class="p-4 text-xl font-bold border-b">Admin Panel</div>
    <nav class="mt-4">
      <ul>
        <li><button onclick="showSection('dashboard')" class="w-full text-left px-4 py-2 hover:bg-gray-200">Dashboard</button></li>
        <li><button onclick="showSection('config')" class="w-full text-left px-4 py-2 hover:bg-gray-200">Configurations</button></li>
        <li><button onclick="showSection('users')" class="w-full text-left px-4 py-2 hover:bg-gray-200">Users</button></li>
        <li><button onclick="showSection('societies')" class="w-full text-left px-4 py-2 hover:bg-gray-200">Societies</button></li>
        <li><button onclick="showSection('orders')" class="w-full text-left px-4 py-2 hover:bg-gray-200">Orders</button></li>
        <li><button onclick="showSection('grains')" class="w-full text-left px-4 py-2 hover:bg-gray-200">Grains</button></li>
      </ul>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-6 overflow-y-auto">

    <!-- Dashboard Section -->
    <section id="section-dashboard">
      <h1 class="text-2xl font-bold mb-6">Dashboard Overview</h1>

      <!-- Top counts (existing) -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
        <div class="bg-white p-6 rounded-lg shadow cursor-pointer" onclick="showSection('users')">
          <h2 class="text-gray-600">Total Users</h2>
          <p id="card-users" class="text-3xl font-bold mt-2">0</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow cursor-pointer" onclick="showSection('societies')">
          <h2 class="text-gray-600">Total Societies</h2>
          <p id="card-societies" class="text-3xl font-bold mt-2">0</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow cursor-pointer" onclick="showSection('orders')">
          <h2 class="text-gray-600">Total Orders</h2>
          <p id="card-orders" class="text-3xl font-bold mt-2">0</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow cursor-pointer" onclick="showSection('grains')">
          <h2 class="text-gray-600">Total Grains</h2>
          <p id="card-grains" class="text-3xl font-bold mt-2">0</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow cursor-pointer" onclick="showSection('config')">
          <h2 class="text-gray-600">Active Configs</h2>
          <p id="card-configs" class="text-3xl font-bold mt-2">0</p>
        </div>
      </div>

      <!-- NEW: Order Status Cards -->
      <div class="mb-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Orders by Status</h2>
          <div class="flex items-center gap-3">
            <button id="refresh-now-btn" onclick="manualRefresh()" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700">Refresh Now</button>
            <div id="last-refresh" class="refresh-meta">Last refreshed: —</div>
          </div>
        </div>

        <div id="status-cards" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
          <!-- Status cards will be injected here by JS -->
        </div>
      </div>

    </section>

    <!-- Configurations -->
    <section id="section-config" class="hidden">
      <h1 class="text-2xl font-bold mb-4">Configuration Management</h1>
      <button onclick="openForm()" class="mb-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">+ Add Configuration</button>
      <table class="w-full border-collapse border border-gray-300">
        <thead class="bg-gray-200"><tr>
          <th class="border p-2">ID</th><th class="border p-2">Key</th>
          <th class="border p-2">Value</th><th class="border p-2">Description</th>
          <th class="border p-2">Actions</th>
        </tr></thead>
        <tbody id="configTable" class="text-center"></tbody>
      </table>
    </section>

    <!-- Orders -->
    <section id="section-orders" class="hidden">
      <h1 class="text-2xl font-bold mb-4">Order Management</h1>
      <div class="mb-4">
        <button onclick="fetchOrders()" class="mr-2 px-3 py-1 border rounded">Show All</button>
        <span id="orders-filter-label" class="text-sm text-gray-600"></span>
      </div>
      <table class="w-full border-collapse border border-gray-300">
        <thead class="bg-gray-200"><tr>
          <th class="border p-2">ID</th><th class="border p-2">Customer ID</th>
          <th class="border p-2">Grain</th><th class="border p-2">Quantity (kg)</th>
          <th class="border p-2">Price</th><th class="border p-2">Order Type</th>
          <th class="border p-2">Payment</th><th class="border p-2">Status</th>
          <th class="border p-2">Created</th><th class="border p-2">Actions</th>
        </tr></thead>
        <tbody id="ordersTable" class="text-center"></tbody>
      </table>
    </section>

    <!-- Users -->
    <section id="section-users" class="hidden">
      <h1 class="text-2xl font-bold mb-4">User Management</h1>
      <p class="text-gray-600">Coming soon...</p>
    </section>

    <!-- Societies -->
    <section id="section-societies" class="hidden">
      <h1 class="text-2xl font-bold mb-4">Society Management</h1>
      <button onclick="openSocietyForm()" class="mb-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">+ Add Society</button>
      <table class="w-full border-collapse border border-gray-300">
        <thead class="bg-gray-200"><tr>
          <th class="border p-2">ID</th><th class="border p-2">Name</th>
          <th class="border p-2">Address</th><th class="border p-2">Contact</th>
          <th class="border p-2">Active</th><th class="border p-2">Actions</th>
        </tr></thead>
        <tbody id="societyTable" class="text-center"></tbody>
      </table>
    </section>

    <!-- Grains -->
    <section id="section-grains" class="hidden">
      <h1 class="text-2xl font-bold mb-4">Grain for Sell Management</h1>
      <button onclick="openGrainForm()" class="mb-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">+ Add Grain for Sell</button>
      <table class="w-full border-collapse border border-gray-300">
        <thead class="bg-gray-200"><tr>
          <th class="border p-2">ID</th><th class="border p-2">Product Name</th>
          <th class="border p-2">Grain</th><th class="border p-2">Price/kg</th>
          <th class="border p-2">Milling Price/kg</th><th class="border p-2">Stock Qty (kg)</th>
          <th class="border p-2">Active</th><th class="border p-2">Actions</th>
        </tr></thead>
        <tbody id="grainTable" class="text-center"></tbody>
      </table>
    </section>
  </main>

  <!-- Config Modal -->
  <div id="configFormModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-96">
      <h2 id="formTitle" class="text-xl font-semibold mb-4">Add Config</h2>
      <input type="hidden" id="configId" />
      <label class="block mb-2 text-sm font-medium">Key</label>
      <input id="configKey" type="text" class="w-full border rounded p-2 mb-4" />
      <label class="block mb-2 text-sm font-medium">Value</label>
      <input id="configValue" type="text" class="w-full border rounded p-2 mb-4" />
      <label class="block mb-2 text-sm font-medium">Description</label>
      <textarea id="configDesc" class="w-full border rounded p-2 mb-4"></textarea>
      <div class="flex justify-end gap-2">
        <button onclick="closeForm()" class="px-4 py-2 border rounded">Cancel</button>
        <button onclick="saveConfig()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Save</button>
      </div>
    </div>
  </div>

  <!-- Society Modal -->
  <div id="societyFormModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-96">
      <h2 id="societyFormTitle" class="text-xl font-semibold mb-4">Add Society</h2>
      <input type="hidden" id="societyId" />
      <label class="block mb-2 text-sm font-medium">Name</label>
      <input id="societyName" type="text" class="w-full border rounded p-2 mb-4" />
      <label class="block mb-2 text-sm font-medium">Address</label>
      <input id="societyAddress" type="text" class="w-full border rounded p-2 mb-4" />
      <label class="block mb-2 text-sm font-medium">Contact</label>
      <input id="societyContact" type="text" class="w-full border rounded p-2 mb-4" />
      <div class="flex justify-end gap-2">
        <button onclick="closeSocietyForm()" class="px-4 py-2 border rounded">Cancel</button>
        <button onclick="saveSociety()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Save</button>
      </div>
    </div>
  </div>

  <!-- Grain Modal -->
  <div id="grainFormModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-96">
      <h2 id="grainFormTitle" class="text-xl font-semibold mb-4">Add Grain for Sell</h2>
      <input type="hidden" id="grainId" />
      <label class="block mb-2 text-sm font-medium">Product Name</label>
      <input id="grainProductName" type="text" class="w-full border rounded p-2 mb-4" />
      <label class="block mb-2 text-sm font-medium">Grain Type</label>
      <input id="grainType" type="text" class="w-full border rounded p-2 mb-4" />
      <label class="block mb-2 text-sm font-medium">Price per kg</label>
      <input id="grainPrice" type="number" step="0.01" class="w-full border rounded p-2 mb-4" />
      <label class="block mb-2 text-sm font-medium">Milling Price per kg</label>
      <input id="grainMillingPrice" type="number" step="0.01" class="w-full border rounded p-2 mb-4" />
      <label class="block mb-2 text-sm font-medium">Stock Quantity (kg)</label>
      <input id="grainStock" type="number" class="w-full border rounded p-2 mb-4" />
      <label class="flex items-center gap-2 mb-4">
        <input id="grainActive" type="checkbox" class="w-4 h-4" />
        <span class="text-sm font-medium">Active</span>
      </label>
      <div class="flex justify-end gap-2">
        <button onclick="closeGrainForm()" class="px-4 py-2 border rounded">Cancel</button>
        <button onclick="saveGrain()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Save</button>
      </div>
    </div>
  </div>

  <!-- Environment config -->
  <script src="config.js"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Main Script -->
  <script>
  const SUPABASE_URL = window._env_.SUPABASE_URL;
  const SUPABASE_KEY = window._env_.SUPABASE_ANON_KEY;
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let configs = [], societies = [], grains = [];
  let editId = null, editSocietyId = null, editGrainId = null;

  function showSection(name){
    document.querySelectorAll("main section").forEach(s=>s.classList.add("hidden"));
    document.getElementById("section-"+name).classList.remove("hidden");
    if(name==="config")fetchConfigs();
    if(name==="societies")fetchSocieties();
    if(name==="orders")fetchOrders();
    if(name==="grains")fetchGrains();
  }

  showSection('dashboard');

  // ---------- CONFIG ----------
  async function fetchConfigs(){
    const {data,error}=await supabase.from('Configuration').select('*').order('id');
    if(error)return console.error(error);
    configs=data;
    const t=document.getElementById("configTable");
    t.innerHTML=data.map(c=>`
      <tr>
        <td class="border p-2">${c.id}</td>
        <td class="border p-2">${c.config_key}</td>
        <td class="border p-2">${c.config_value}</td>
        <td class="border p-2">${c.description||'-'}</td>
        <td class="border p-2">
          <button onclick="editConfig(${c.id})" class="px-2 py-1 bg-yellow-500 text-white rounded">Edit</button>
          <button onclick="deleteConfig(${c.id})" class="px-2 py-1 bg-red-600 text-white rounded">Delete</button>
        </td></tr>`).join('');
    document.getElementById("card-configs").innerText=data.length;
  }

  function openForm(){document.getElementById("configFormModal").classList.remove("hidden")}
  function closeForm(){document.getElementById("configFormModal").classList.add("hidden")}
  async function saveConfig(){
    const key=configKey.value.trim(),val=configValue.value.trim(),desc=configDesc.value.trim();
    if(editId)await supabase.from('Configuration').update({config_key:key,config_value:val,description:desc}).eq('id',editId);
    else await supabase.from('Configuration').insert([{config_key:key,config_value:val,description:desc}]);
    closeForm();fetchConfigs(); refreshDashboardCountsAndStatuses();
  }
  function editConfig(id){const c=configs.find(x=>x.id===id);editId=id;openForm();configKey.value=c.config_key;configValue.value=c.config_value;configDesc.value=c.description||""}
  async function deleteConfig(id){await supabase.from('Configuration').delete().eq('id',id);fetchConfigs(); refreshDashboardCountsAndStatuses();}

  // ---------- SOCIETIES ----------
  async function fetchSocieties(){
    const {data,error}=await supabase.from('societies').select('*').order('created_at',{ascending:false});
    if(error)return console.error(error);
    societies=data;
    document.getElementById("societyTable").innerHTML=data.map(s=>`
      <tr>
        <td class="border p-2">${s.id}</td><td class="border p-2">${s.name}</td>
        <td class="border p-2">${s.address||'-'}</td><td class="border p-2">${s.contact_number||'-'}</td>
        <td class="border p-2">${s.is_active?'✅':'❌'}</td>
        <td class="border p-2">
          <button onclick="editSociety(${s.id})" class="px-2 py-1 bg-yellow-500 text-white rounded">Edit</button>
          <button onclick="deleteSociety(${s.id})" class="px-2 py-1 bg-red-600 text-white rounded">Delete</button>
        </td></tr>`).join('');
    document.getElementById("card-societies").innerText=data.length;
  }
  function openSocietyForm(){document.getElementById("societyFormModal").classList.remove("hidden")}
  function closeSocietyForm(){document.getElementById("societyFormModal").classList.add("hidden")}
  async function saveSociety(){
    const n=societyName.value.trim(),a=societyAddress.value.trim(),c=societyContact.value.trim();
    if(editSocietyId)await supabase.from('societies').update({name:n,address:a,contact_number:c}).eq('id',editSocietyId);
    else await supabase.from('societies').insert([{name:n,address:a,contact_number:c}]);
    closeSocietyForm();fetchSocieties(); refreshDashboardCountsAndStatuses();
  }
  function editSociety(id){const s=societies.find(x=>x.id===id);editSocietyId=id;openSocietyForm();societyName.value=s.name;societyAddress.value=s.address||"";societyContact.value=s.contact_number||""}
  async function deleteSociety(id){await supabase.from('societies').delete().eq('id',id);fetchSocieties(); refreshDashboardCountsAndStatuses();}

  // ---------- ORDERS ----------
  // Modified: fetchOrders accepts optional statusId to filter orders
  async function fetchOrders(statusId = null){
    // update filter label
    const filterLabel = document.getElementById('orders-filter-label');
    if(statusId) {
      // find status name for display
      const { data: st } = await supabase.from('order_statuses').select('status_name').eq('id', statusId).maybeSingle();
      filterLabel.innerText = st ? `Filtered: ${st.status_name}` : '';
    } else {
      filterLabel.innerText = '';
    }

    let query = supabase.from('orders').select('*').order('created_at',{ascending:false}).limit(200);
    if(statusId) query = query.eq('status_id', statusId);

    const {data,error} = await query;
    if(error) return console.error(error);

    document.getElementById("ordersTable").innerHTML=data.map(o=>`
      <tr><td class="border p-2">${o.id}</td><td class="border p-2">${o.customer_id||'-'}</td>
      <td class="border p-2">${o.grain_type||'-'}</td><td class="border p-2">${o.quantity_kg||'-'}</td>
      <td class="border p-2">${o.total_price||'-'}</td><td class="border p-2">${o.order_type||'-'}</td>
      <td class="border p-2">${o.payment_status||'-'}</td><td class="border p-2">${o.status_backup||'-'}</td>
      <td class="border p-2">${o.created_at?new Date(o.created_at).toLocaleString():'-'}</td>
      <td class="border p-2"><button onclick="deleteOrder(${o.id})" class="px-2 py-1 bg-red-600 text-white rounded">Delete</button></td></tr>`).join('');
    document.getElementById("card-orders").innerText = data.length;
  }
  async function deleteOrder(id){await supabase.from('orders').delete().eq('id',id);fetchOrders(); refreshDashboardCountsAndStatuses();}

  // ---------- GRAINS ----------
  async function fetchGrains(){
    const {data,error}=await supabase.from('Grain_for_sell').select('*').order('id');
    if(error)return console.error(error);
    grains=data;renderGrainTable();
  }
  function renderGrainTable(){
    document.getElementById("grainTable").innerHTML=grains.map(g=>`
      <tr>
        <td class="border p-2">${g.id}</td><td class="border p-2">${g.product_name}</td>
        <td class="border p-2">${g.grain||'-'}</td><td class="border p-2">${g.price_per_kg}</td>
        <td class="border p-2">${g.milling_price_per_kg}</td><td class="border p-2">${g.stock_qty}</td>
        <td class="border p-2">${g.is_active?'✅':'❌'}</td>
        <td class="border p-2"><button onclick="editGrain(${g.id})" class="px-2 py-1 bg-yellow-500 text-white rounded">Edit</button>
        <button onclick="deleteGrain(${g.id})" class="px-2 py-1 bg-red-600 text-white rounded">Delete</button></td>
      </tr>`).join('');
    document.getElementById("card-grains").innerText=grains.length;
  }
  function openGrainForm(){grainFormModal.classList.remove("hidden");grainFormTitle.innerText="Add Grain";grainProductName.value="";grainType.value="";grainPrice.value="";grainMillingPrice.value="";grainStock.value="";grainActive.checked=true;editGrainId=null;}
  function closeGrainForm(){grainFormModal.classList.add("hidden")}
  async function saveGrain(){
    const product_name=grainProductName.value.trim(),grain=grainType.value.trim(),price_per_kg=parseFloat(grainPrice.value)||0,milling_price_per_kg=parseFloat(grainMillingPrice.value)||0,stock_qty=parseInt(grainStock.value)||0,is_active=grainActive.checked;
    if(!product_name||!grain){alert("Please fill all required fields");return;}
    if(editGrainId)await supabase.from('Grain_for_sell').update({product_name,grain,price_per_kg,milling_price_per_kg,stock_qty,is_active}).eq('id',editGrainId);
    else await supabase.from('Grain_for_sell').insert([{product_name,grain,price_per_kg,milling_price_per_kg,stock_qty,is_active}]);
    closeGrainForm();fetchGrains(); refreshDashboardCountsAndStatuses();
  }
  function editGrain(id){const g=grains.find(x=>x.id===id);editGrainId=id;openGrainForm();grainProductName.value=g.product_name;grainType.value=g.grain||"";grainPrice.value=g.price_per_kg;grainMillingPrice.value=g.milling_price_per_kg;grainStock.value=g.stock_qty;grainActive.checked=g.is_active;}
  async function deleteGrain(id){if(!confirm("Delete this grain?"))return;await supabase.from('Grain_for_sell').delete().eq('id',id);fetchGrains(); refreshDashboardCountsAndStatuses();}

  // ---------- STATUS CARDS + AUTO-REFRESH (NEW) ----------
  // Mapping status names -> badge classes
  const STATUS_CLASS_MAP = {
    "NEW":               "bg-yellow-100 text-yellow-800",
    "IN PROCESS":        "bg-blue-100 text-blue-800",
    "MILLING COMPLETED": "bg-green-100 text-green-800",
    "DELIVERED":         "bg-gray-200 text-gray-800",
    "PICKED UP":         "bg-purple-100 text-purple-800",
    "RECEIVED AT MILL":  "bg-orange-100 text-orange-800",
    "OUT FOR DELIVERY":  "bg-pink-100 text-pink-800"
  };

  let prevNewCount = null;         // previous NEW orders count to detect new orders
  let refreshIntervalMs = 60000;   // 1 minute
  let refreshTimer = null;

  // Play a short chime using Web Audio API (no external files)
  function playChime() {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'sine';
      o.frequency.value = 880; // A5
      g.gain.value = 0;
      o.connect(g);
      g.connect(ctx.destination);

      const now = ctx.currentTime;
      g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(0.12, now + 0.01);
      o.start(now);
      // quick upward glide
      o.frequency.exponentialRampToValueAtTime(1320, now + 0.12);
      g.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
      o.stop(now + 0.55);
      // close context after short delay
      setTimeout(()=>{ try{ ctx.close(); }catch(e){} }, 800);
    } catch (e) {
      // If AudioContext not available or blocked, fail silently
      console.warn("Audio chime failed:", e);
    }
  }

  // Format small time for "Last refreshed"
  function formatTime(ts) {
    try { return new Date(ts).toLocaleString(); } catch(e) { return new Date().toLocaleString(); }
  }

  // Manual refresh handler from button
  async function manualRefresh() {
    await refreshDashboardCountsAndStatuses(true);
  }

  // Fetch statuses, counts and render cards.
  async function fetchAndRenderStatusCards() {
    const container = document.getElementById('status-cards');
    container.innerHTML = `<div class="col-span-full text-sm text-gray-500">Loading...</div>`;

    // fetch statuses
    const { data: statuses, error: statusErr } = await supabase.from('order_statuses').select('*').order('id');
    if(statusErr) {
      console.error(statusErr);
      container.innerHTML = `<div class="col-span-full text-sm text-red-600">Failed to load statuses</div>`;
      return;
    }

    // Build cards: First "All" then statuses
    const cards = [];
    const { count: totalCount } = await supabase.from('orders').select('id', { count: 'exact', head: true });
    cards.push({
      id: null,
      name: 'ALL',
      count: totalCount || 0,
      badgeClass: 'bg-white text-gray-800'
    });

    // Fetch counts per status (we use head:true exact count queries)
    for(const st of statuses){
      const { count } = await supabase.from('orders').select('id', { count: 'exact', head: true }).eq('status_id', st.id);
      // choose badge classes from STATUS_CLASS_MAP; default fallback
      const badgeClass = STATUS_CLASS_MAP[(st.status_name || '').toUpperCase()] || 'bg-white text-gray-800';
      cards.push({
        id: st.id,
        name: st.status_name || 'UNKNOWN',
        count: count || 0,
        badgeClass
      });
    }

    // Render cards
    container.innerHTML = cards.map(c => `
      <div class="p-4 rounded-lg shadow bg-white cursor-pointer hover:shadow-md flex flex-col items-start justify-between"
           onclick="onStatusCardClick(${c.id === null ? 'null' : c.id})"
           role="button" aria-pressed="false">
        <div class="flex items-center gap-2 w-full">
          <div class="status-badge ${c.badgeClass}">${escapeHtml(c.name)}</div>
          <div class="text-sm text-gray-500 ml-auto">${c.count}</div>
        </div>
        <div class="mt-2 text-xs text-gray-500">Click to filter</div>
      </div>
    `).join('');

    return cards;
  }

  // Escape small HTML in case statuses contain special chars
  function escapeHtml(s) { return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]); }

  // When a status card clicked: open Orders section and filter by statusId (null -> all)
  function onStatusCardClick(statusId) {
    showSection('orders');
    if(statusId === null) fetchOrders(); // show all
    else fetchOrders(statusId);
    // scroll to top of orders section
    setTimeout(()=> { document.getElementById('section-orders').scrollIntoView({behavior:'smooth'}); }, 50);
  }

  // Refresh top counts and status cards.
  // if manual = true, we always update timestamp and treat it as a manual refresh.
  async function refreshDashboardCountsAndStatuses(manual = false) {
    try {
      // capture NEW count before refresh for comparison
      const prevNew = prevNewCount;

      // refresh top-level counts
      try {
        const { data: configsData } = await supabase.from('Configuration').select('*').order('id');
        document.getElementById("card-configs").innerText = configsData ? configsData.length : 0;
      } catch(e){ console.error(e); }

      try {
        const { data: societiesData } = await supabase.from('societies').select('*');
        document.getElementById("card-societies").innerText = societiesData ? societiesData.length : 0;
      } catch(e){ console.error(e); }

      try {
        const { data: grainsData } = await supabase.from('Grain_for_sell').select('*');
        document.getElementById("card-grains").innerText = grainsData ? grainsData.length : 0;
      } catch(e){ console.error(e); }

      try {
        const { count } = await supabase.from('orders').select('id', { count: 'exact', head: true });
        document.getElementById("card-orders").innerText = count || 0;
      } catch(e){ console.error(e); }

      try {
        const { data: usersData } = await supabase.from('customers').select('*');
        document.getElementById("card-users").innerText = usersData ? usersData.length : 0;
      } catch(e){ console.error(e); }

      // fetch + render status cards and get card data back
      const cards = await fetchAndRenderStatusCards();

      // find NEW count from cards (case-insensitive match)
      const newCard = cards.find(c => (c.name || '').toString().toUpperCase() === 'NEW') || null;
      const currentNewCount = newCard ? (Number(newCard.count) || 0) : 0;

      // if prevNewCount is not null and currentNewCount > prevNewCount, play chime
      if (prevNewCount !== null && currentNewCount > prevNewCount) {
        playChime();
      }

      // update prevNewCount for next run
      prevNewCount = currentNewCount;

      // update last refreshed timestamp element
      const now = new Date();
      document.getElementById('last-refresh').innerText = `Last refreshed: ${formatTime(now)}`;

      // if this was a manual refresh, also update status filter label if we're in orders page
      if (manual) {
        // if currently showing orders with a filter, re-run fetchOrders with the same filter label if present
        // (we don't change the filter here — fetchOrders will show what's selected)
        const lbl = document.getElementById('orders-filter-label').innerText;
        if (lbl && lbl.startsWith('Filtered:')) {
          // keep current filter; do nothing here
        }
      }

    } catch (err) {
      console.error("Error refreshing dashboard:", err);
    }
  }

  // call refresh when app starts and whenever dashboard shown
  refreshDashboardCountsAndStatuses();

  // start periodic refresh (1 minute)
  function startAutoRefresh() {
    if (refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(()=> refreshDashboardCountsAndStatuses(false), refreshIntervalMs);
  }
  startAutoRefresh();

  // Re-use existing fetchGrains/fetchSocieties/fetchConfigs functions below...
  // (functions already defined earlier — fetchGrains(), etc.)

  // ensure that after an order is deleted or created, dashboard counts refresh
  async function deleteOrder(id){
    if(!confirm('Delete order?')) return;
    await supabase.from('orders').delete().eq('id',id);
    await fetchOrders();
    await refreshDashboardCountsAndStatuses();
  }

  // Call refreshDashboardCountsAndStatuses after operations that change counts
  // (saveGrain, saveSociety, saveConfig already call it above)

  </script>
</body>
</html>
