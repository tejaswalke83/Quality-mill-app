<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Delivery - Orders</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .order-icon { width: 20px; height: 20px; } /* slightly smaller to match card */
    .society-section { border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; }

    /* Tabs styling (clean tab look) */
    .tabs { display:flex; gap:8px; background:transparent; }
    .tab {
      padding: 10px 14px;
      border-radius: 10px 10px 0 0;
      cursor: pointer;
      font-weight: 600;
      color: #374151; /* gray-700 */
      background: transparent;
      border-bottom: 2px solid transparent;
    }
    .tab:hover { background: rgba(15, 23, 42, 0.03); }
    .tab.active {
      color: #0b74ff; /* blue */
      border-bottom-color: #0b74ff;
      background: white;
      box-shadow: 0 2px 6px rgba(11,116,255,0.08);
    }
    .tab-badge {
      display:inline-block;
      margin-left:8px;
      background:#eef2ff;
      color:#4338ca;
      padding:2px 8px;
      border-radius:999px;
      font-weight:700;
      font-size:12px;
    }

    /* Card tweaks to match sample layout */
    .order-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 1px 4px rgba(16,24,40,0.06);
      transition: box-shadow .15s;
    }
    .order-card:hover { box-shadow: 0 6px 18px rgba(16,24,40,0.08); cursor: pointer; }
    .order-token { color: #6b7280; font-size: 14px; } /* gray-500 */
    .order-name { font-size: 18px; font-weight: 700; color: #111827; margin-top: 6px; }
    .order-meta { font-size: 13px; color: #4b5563; } /* gray-600 */
    .order-total { font-size: 16px; font-weight: 700; margin-top: 8px; color: #111827; }
    .order-footer { display:flex; justify-content:space-between; align-items:center; margin-top:12px; }
    .status-badge { font-size: 12px; padding: 6px 8px; border-radius: 8px; display:inline-block; }

    /* small responsive tweaks */
    @media (max-width: 640px) {
      .tab { padding:8px 10px; font-size:14px; }
      .order-card { padding: 12px; }
    }
  </style>
  <script defer src="/common.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <h1 class="text-2xl font-bold text-center mb-6">Delivery Partner — Orders</h1>

  <div class="max-w-5xl mx-auto">
    <!-- Tabs -->
    <div class="bg-white shadow rounded-t-lg p-4 mb-0">
      <div class="flex items-center justify-between">
        <div class="tabs" role="tablist" aria-label="Order tabs">
          <div id="tabOpen" class="tab active" role="tab" aria-selected="true">Open Orders <span id="countOpen" class="tab-badge">0</span></div>
          <div id="tabDelivered" class="tab" role="tab" aria-selected="false">Delivery Done <span id="countDelivered" class="tab-badge">0</span></div>
          <div id="tabPicked" class="tab" role="tab" aria-selected="false">Pickup Done <span id="countPicked" class="tab-badge">0</span></div>
        </div>
      </div>
    </div>

    <!-- Filters / Search -->
    <div class="bg-white shadow rounded-b-lg p-4 mb-6">
      <div class="flex gap-3 items-center">
        <input id="searchBox" type="text"
               placeholder="Search by name, phone, token, address, society..."
               oninput="debouncedReload()" class="flex-1 border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
        <button onclick="reloadOrders()" class="px-4 py-2 bg-blue-500 text-white rounded">Refresh</button>
      </div>
    </div>

    <!-- Orders Container -->
    <div id="ordersContainer" class="space-y-4"></div>
  </div>

  <!-- Modal for status change -->
  <div id="orderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg max-w-lg w-full p-6 relative">
      <button onclick="closeModal()" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700">✖</button>
      <div id="modalContent"></div>
    </div>
  </div>

  <script src="config.js"></script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const SUPABASE_URL = window._env_?.SUPABASE_URL;
    const SUPABASE_KEY = window._env_?.SUPABASE_ANON_KEY;
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const PINWHEEL_URL = "https://openmoji.org/data/color/svg/1F33E.svg";
    const SCOOTER_URL = "https://openmoji.org/data/color/svg/1F6F5.svg";

    let statusesCache = [];
    let statusFlows = {};
    let currentTab = 'open'; // 'open' | 'picked' | 'delivered'
    let searchTimeout;

    function getStatusClass(status) {
      const map = {
        "NEW": "bg-yellow-100 text-yellow-800",
        "IN PROCESS": "bg-blue-100 text-blue-800",
        "MILLING COMPLETED": "bg-green-100 text-green-800",
        "DELIVERED": "bg-gray-200 text-gray-800",
        "PICKED UP": "bg-purple-100 text-purple-800",
        "PICKEDUP": "bg-purple-100 text-purple-800",
        "PICKED_UP": "bg-purple-100 text-purple-800",
        "PICKED-UP": "bg-purple-100 text-purple-800",
        "RECEIVED AT MILL": "bg-orange-100 text-orange-800",
        "OUT FOR DELIVERY": "bg-pink-100 text-pink-800"
      };
      return map[status] || "bg-gray-100 text-gray-700";
    }

    function getOrderIconHTML(order) {
      const pin = `<img src="${PINWHEEL_URL}" class="order-icon inline-block mr-2" />`;
      const scoot = `<img src="${SCOOTER_URL}" class="order-icon inline-block mr-2" />`;
      if (order.order_type === 'shop-buy-mill') return pin;
      if (order.order_type === 'home-milling') return scoot;
      if (order.order_type === 'home-buy-mill') return pin + scoot;
      return '';
    }

    async function fetchStatuses() {
      const { data, error } = await supabase.from('order_statuses').select('*').order('sort_order', { ascending: true });
      if (error) {
        console.error('fetchStatuses:', error);
        statusesCache = [];
      } else statusesCache = data || [];
      return statusesCache;
    }

    async function buildStatusFlows() {
      await fetchStatuses();
      const statusMap = {};
      statusesCache.forEach(s => statusMap[s.status_name] = s.id);

      return {
        "shop-milling": [statusMap["NEW"], statusMap["IN PROCESS"], statusMap["MILLING COMPLETED"], statusMap["DELIVERED"]],
        "shop-buy-mill": [statusMap["NEW"], statusMap["IN PROCESS"], statusMap["MILLING COMPLETED"], statusMap["DELIVERED"]],
        "home-milling": [statusMap["NEW"], statusMap["PICKED UP"], statusMap["RECEIVED AT MILL"], statusMap["IN PROCESS"], statusMap["MILLING COMPLETED"], statusMap["OUT FOR DELIVERY"], statusMap["DELIVERED"]],
        "home-buy-mill": [statusMap["NEW"], statusMap["IN PROCESS"], statusMap["MILLING COMPLETED"], statusMap["OUT FOR DELIVERY"], statusMap["DELIVERED"]]
      };
    }

    function getNextStatus(order) {
      const flow = statusFlows[order.order_type] || [];
      const idx = flow.indexOf(order.status_id);
      if (idx === -1 || idx + 1 >= flow.length) return null;
      return statusesCache.find(s => s.id === flow[idx + 1]) || null;
    }

    function getStatusIdByName(name) {
      if (!name) return null;
      const normalized = name.toString().trim().toUpperCase();
      const live = statusesCache.find(x => (x.status_name || '').toUpperCase() === normalized);
      if (live) return live.id;
      const fallback = {
        'NEW': '465bf226-1312-4708-a99e-bf90e400f7e0',
        'PICKED UP': '24cd0820-1735-4017-aeaf-9463c08820f6',
        'RECEIVED AT MILL': '15b2a302-64f4-4fdf-b021-be497f2b38f3',
        'IN PROCESS': 'c1dd1b37-62c4-46f5-a134-b50a7ca66588',
        'MILLING COMPLETED': 'a396305a-8b27-4d5d-b3ce-408fb875d29',
        'OUT FOR DELIVERY': '0b7136c4-1392-40df-bd1a-20df5df98656',
        'DELIVERED': 'a8909616-20ad-44f3-9d78-bc2b22ccd60',
        'ARCHIEVED': '9a30f2df-199d-439f-9fef-9dbd088be84a'
      };
      return fallback[normalized] || null;
    }

    async function fetchOrdersFromDB() {
      const { data, error } = await supabase
        .from('orders')
        .select(`
          *,
          customers(*),
          order_statuses(status_name, sort_order, id)
        `)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('fetchOrdersFromDB:', error);
        const container = document.getElementById('ordersContainer') || document.getElementById('ordersList');
        if (container) {
          container.innerHTML = '';
          const errEl = document.createElement('div');
          errEl.className = 'text-red-600 text-sm p-3';
          errEl.textContent = `Error fetching orders: ${error.message || error.code || 'unknown'}`;
          container.appendChild(errEl);
        }
        return [];
      }

      return data || [];
    }

    function getFullAddress(order) {
      const c = order.customers || {};
      const parts = [];
      if (c.address_line) parts.push(c.address_line);
      if (c.address) {
        if (typeof c.address === 'string') parts.push(c.address);
        else {
          if (c.address.line1) parts.push(c.address.line1);
          if (c.address.line2) parts.push(c.address.line2);
          if (c.address.street) parts.push(c.address.street);
          if (c.address.locality) parts.push(c.address.locality);
          if (c.address.society) parts.push(c.address.society);
          if (c.address.socity) parts.push(c.address.socity);
          if (c.address.city) parts.push(c.address.city);
          if (c.address.state) parts.push(c.address.state);
          if (c.address.pincode) parts.push(c.address.pincode);
        }
      }
      if (c.street) parts.push(c.street);
      if (c.city) parts.push(c.city);
      if (c.state) parts.push(c.state);
      if (c.pincode) parts.push(c.pincode);
      if (c.zip) parts.push(c.zip);
      if (c.postal_code) parts.push(c.postal_code);
      if (c.metadata && typeof c.metadata === 'object') {
        if (c.metadata.address) parts.push(c.metadata.address);
        if (c.metadata.locality) parts.push(c.metadata.locality);
      }
      return parts.filter(Boolean).join(', ') || 'Address not available';
    }

    function getSocietyName(order) {
      const c = order.customers || {};
      return c.society || c.society_name || c.societyId || c.society_id ||
             (c.address && (c.address.society || c.address.locality || c.address.socity)) ||
             (c.metadata && (c.metadata.society || c.metadata.locality)) ||
             "Other";
    }

    async function renderOrders() {
      await fetchStatuses();
      const all = await fetchOrdersFromDB();

      // only home orders
      const homeOrders = all.filter(o => ['home-milling','home-buy-mill'].includes(o.order_type));

      // open: OUT FOR DELIVERY OR NEW (NEW only for home-milling)
      const openOrders = homeOrders.filter(o => {
        const statusObj = statusesCache.find(s => s.id === o.status_id) || {};
        const statusName = (statusObj.status_name || '').toUpperCase();
        if (statusName === "OUT FOR DELIVERY") return true;
        if (statusName === "NEW" && o.order_type === "home-milling") return true;
        return false;
      });

      // pickup done: PICKED UP
      const pickedOrders = homeOrders.filter(o => {
        const statusObj = statusesCache.find(s => s.id === o.status_id) || {};
        const statusName = (statusObj.status_name || '').toUpperCase();
        return statusName === "PICKED UP" || statusName === "PICKEDUP" || statusName === "PICKED_UP" || statusName === "PICKED-UP";
      });

      // delivery done: DELIVERED
      const deliveredOrders = homeOrders.filter(o => {
        const statusObj = statusesCache.find(s => s.id === o.status_id) || {};
        const statusName = (statusObj.status_name || '').toUpperCase();
        return statusName === "DELIVERED";
      });

      // update tab counts
      document.getElementById('countOpen').textContent = openOrders.length;
      document.getElementById('countPicked').textContent = pickedOrders.length;
      document.getElementById('countDelivered').textContent = deliveredOrders.length;

      const searchTerm = (document.getElementById('searchBox').value || '').toLowerCase().trim();

      function filterList(list) {
        return list.filter(o => {
          if (!searchTerm) return true;
          const name = (o.customers?.name || '').toLowerCase();
          const phone = String(o.customers?.phone_number || '').toLowerCase();
          const token = String(o.token_number || '').toLowerCase();
          const total = String(o.total_price || '').toLowerCase();
          const addr = getFullAddress(o).toLowerCase();
          const society = getSocietyName(o).toLowerCase();
          const statusName = (statusesCache.find(s => s.id === o.status_id)?.status_name || '').toLowerCase();

          return name.includes(searchTerm) || phone.includes(searchTerm) || token.includes(searchTerm) ||
                 total.includes(searchTerm) || addr.includes(searchTerm) || society.includes(searchTerm) ||
                 statusName.includes(searchTerm);
        });
      }

      const filteredOpen = filterList(openOrders);
      const filteredPicked = filterList(pickedOrders);
      const filteredDelivered = filterList(deliveredOrders);

      const container = document.getElementById('ordersContainer');
      container.innerHTML = '';

      if (currentTab === 'open') {
        if (filteredOpen.length === 0) {
          container.innerHTML = '<p class="text-gray-500">No open orders found.</p>';
          return;
        }

        // group by society
        const groups = {};
        filteredOpen.forEach(o => {
          const s = getSocietyName(o);
          groups[s] = groups[s] || [];
          groups[s].push(o);
        });

        Object.keys(groups).forEach(soc => {
          const section = document.createElement('div');
          section.className = 'society-section bg-white p-4 shadow rounded-lg mb-4';
          const hdr = document.createElement('div');
          hdr.className = 'flex justify-between items-center mb-3';
          hdr.innerHTML = `<div class="font-semibold">${soc} <span class="text-sm text-gray-500">(${groups[soc].length})</span></div>`;
          section.appendChild(hdr);

          groups[soc].forEach(order => {
            const statusObj = statusesCache.find(s => s.id === order.status_id);
            const statusLabel = statusObj ? statusObj.status_name : 'Unknown';
            const statusClass = getStatusClass(statusLabel);

            // create grains HTML (bulleted) similar to popup
            const grainsHTML = Array.isArray(order.grain_details) ?
              `<ul class="list-disc ml-6 text-sm text-gray-600">${order.grain_details.map(g => `<li>${g.grain} - ${g.quantity} kg</li>`).join('')}</ul>` : '';

            const societyName = getSocietyName(order);
            const flat = order.customers?.flat_number || order.customers?.flat || order.customers?.flatNo || order.customers?.flat_no || '';
            const wing = order.customers?.wing || order.customers?.block || '';

            const card = document.createElement('div');
            card.className = 'order-card mb-3';
            /* layout updated: token top-right, name, phone line, created line, society line, wing line, flat line, Grains label + list, total, footer */
            card.innerHTML = `
              <div class="flex items-start justify-between">
                <div class="flex items-center gap-2">
                  ${getOrderIconHTML(order)}
                </div>
                <div class="order-token text-right">Token: ${order.token_number || ''}</div>
              </div>

              <div class="order-name">${order.customers?.name || 'N/A'}</div>

              <div class="flex items-center justify-between mt-2">
                <div class="order-meta">
                  <strong>Phone:</strong>
                  <a href="tel:${order.customers?.phone_number || ''}" class="text-blue-600 underline">${order.customers?.phone_number || 'N/A'}</a>
                </div>
                <div class="order-meta text-right"></div>
              </div>

              <div class="order-meta mt-1">${window.convertUTCToIST ? window.convertUTCToIST(order.created_at) : order.created_at}</div>

              <div class="order-meta mt-1"><strong>Society:</strong> ${societyName}</div>
              <div class="order-meta mt-1"><strong>Wing:</strong> ${wing || '-'}</div>
              <div class="order-meta mt-1"><strong>Flat:</strong> ${flat || '-'}</div>

              <div class="order-meta mt-2"><strong>Grains:</strong></div>
              ${grainsHTML}

              <div class="order-total">Total: ₹${(order.total_price||0).toFixed(2)}</div>

              <div class="order-footer">
                <div><span class="status-badge ${statusClass}">${statusLabel}</span></div>
                <div class="text-sm text-gray-600">${order.payment_status || 'Not Paid'}</div>
              </div>
            `;
            card.addEventListener('click', () => openModal(order));
            section.appendChild(card);
          });

          container.appendChild(section);
        });

      } else if (currentTab === 'picked') {
        if (filteredPicked.length === 0) {
          container.innerHTML = '<p class="text-gray-500">No pickup-done orders found.</p>';
          return;
        }

        const groups = {};
        filteredPicked.forEach(o => {
          const s = getSocietyName(o);
          groups[s] = groups[s] || [];
          groups[s].push(o);
        });

        Object.keys(groups).forEach(soc => {
          const section = document.createElement('div');
          section.className = 'society-section bg-white p-4 shadow rounded-lg mb-4';
          const hdr = document.createElement('div');
          hdr.className = 'flex justify-between items-center mb-3';
          hdr.innerHTML = `<div class="font-semibold">${soc} <span class="text-sm text-gray-500">(${groups[soc].length})</span></div>`;
          section.appendChild(hdr);

          groups[soc].forEach(order => {
            const statusObj = statusesCache.find(s => s.id === order.status_id);
            const statusLabel = statusObj ? statusObj.status_name : 'Unknown';
            const statusClass = getStatusClass(statusLabel);

            const grainsHTML = Array.isArray(order.grain_details) ?
              `<ul class="list-disc ml-6 text-sm text-gray-600">${order.grain_details.map(g => `<li>${g.grain} - ${g.quantity} kg</li>`).join('')}</ul>` : '';

            const societyName = getSocietyName(order);
            const flat = order.customers?.flat_number || order.customers?.flat || order.customers?.flatNo || order.customers?.flat_no || '';
            const wing = order.customers?.wing || order.customers?.block || '';

            const card = document.createElement('div');
            card.className = 'order-card mb-3';
            card.innerHTML = `
              <div class="flex items-start justify-between">
                <div class="flex items-center gap-2">
                  ${getOrderIconHTML(order)}
                </div>
                <div class="order-token text-right">Token: ${order.token_number || ''}</div>
              </div>

              <div class="order-name">${order.customers?.name || 'N/A'}</div>

              <div class="flex items-center justify-between mt-2">
                <div class="order-meta">
                  <strong>Phone:</strong>
                  <a href="tel:${order.customers?.phone_number || ''}" class="text-blue-600 underline">${order.customers?.phone_number || 'N/A'}</a>
                </div>
                <div class="order-meta text-right"></div>
              </div>

              <div class="order-meta mt-1">${window.convertUTCToIST ? window.convertUTCToIST(order.created_at) : order.created_at}</div>

              <div class="order-meta mt-1"><strong>Society:</strong> ${societyName}</div>
              <div class="order-meta mt-1"><strong>Wing:</strong> ${wing || '-'}</div>
              <div class="order-meta mt-1"><strong>Flat:</strong> ${flat || '-'}</div>

              <div class="order-meta mt-2"><strong>Grains:</strong></div>
              ${grainsHTML}

              <div class="order-total">Total: ₹${(order.total_price||0).toFixed(2)}</div>

              <div class="order-footer">
                <div><span class="status-badge ${statusClass}">${statusLabel}</span></div>
                <div class="text-sm text-gray-600">${order.payment_status || 'Not Paid'}</div>
              </div>
            `;
            section.appendChild(card);
          });

          container.appendChild(section);
        });

      } else { // delivered tab (Delivery Done)
        if (filteredDelivered.length === 0) {
          container.innerHTML = '<p class="text-gray-500">No delivery-done orders yet.</p>';
          return;
        }

        const groups = {};
        filteredDelivered.forEach(o => {
          const s = getSocietyName(o);
          groups[s] = groups[s] || [];
          groups[s].push(o);
        });

        Object.keys(groups).forEach(soc => {
          const section = document.createElement('div');
          section.className = 'society-section bg-white p-4 shadow rounded-lg mb-4';
          const hdr = document.createElement('div');
          hdr.className = 'flex justify-between items-center mb-3';
          hdr.innerHTML = `<div class="font-semibold">${soc} <span class="text-sm text-gray-500">(${groups[soc].length})</span></div>`;
          section.appendChild(hdr);

          groups[soc].forEach(order => {
            const statusObj = statusesCache.find(s => s.id === order.status_id);
            const statusLabel = statusObj ? statusObj.status_name : 'Unknown';
            const statusClass = getStatusClass(statusLabel);

            const grainsHTML = Array.isArray(order.grain_details) ?
              `<ul class="list-disc ml-6 text-sm text-gray-600">${order.grain_details.map(g => `<li>${g.grain} - ${g.quantity} kg</li>`).join('')}</ul>` : '';

            const societyName = getSocietyName(order);
            const flat = order.customers?.flat_number || order.customers?.flat || order.customers?.flatNo || order.customers?.flat_no || '';
            const wing = order.customers?.wing || order.customers?.block || '';

            const card = document.createElement('div');
            card.className = 'order-card mb-3';
            card.innerHTML = `
              <div class="flex items-start justify-between">
                <div class="flex items-center gap-2">
                  ${getOrderIconHTML(order)}
                </div>
                <div class="order-token text-right">Token: ${order.token_number || ''}</div>
              </div>

              <div class="order-name">${order.customers?.name || 'N/A'}</div>

              <div class="flex items-center justify-between mt-2">
                <div class="order-meta">
                  <strong>Phone:</strong>
                  <a href="tel:${order.customers?.phone_number || ''}" class="text-blue-600 underline">${order.customers?.phone_number || 'N/A'}</a>
                </div>
                <div class="order-meta text-right"></div>
              </div>

              <div class="order-meta mt-1">${window.convertUTCToIST ? window.convertUTCToIST(order.created_at) : order.created_at}</div>

              <div class="order-meta mt-1"><strong>Society:</strong> ${societyName}</div>
              <div class="order-meta mt-1"><strong>Wing:</strong> ${wing || '-'}</div>
              <div class="order-meta mt-1"><strong>Flat:</strong> ${flat || '-'}</div>

              <div class="order-meta mt-2"><strong>Grains:</strong></div>
              ${grainsHTML}

              <div class="order-total">Total: ₹${(order.total_price||0).toFixed(2)}</div>

              <div class="order-footer">
                <div><span class="status-badge ${statusClass}">${statusLabel}</span></div>
                <div class="text-sm text-gray-600">${order.payment_status || 'Not Paid'}</div>
              </div>
            `;
            section.appendChild(card);
          });

          container.appendChild(section);
        });
      }
    }

    function openModal(order) {
      const modal = document.getElementById("orderModal");
      const content = document.getElementById("modalContent");
      const statusObj = statusesCache.find(s => s.id === order.status_id);
      const statusLabel = statusObj ? statusObj.status_name : 'Unknown';
      const next = getNextStatus(order);

      const allowDeliver = (statusLabel.toUpperCase() === "OUT FOR DELIVERY") || (next && next.status_name === "DELIVERED");
      // allow marking picked up if order is NEW and home-milling
      const allowPickUp = (statusLabel.toUpperCase() === "NEW" && order.order_type === "home-milling");

      const grainsHTML = Array.isArray(order.grain_details)
        ? '<ul class="list-disc ml-6 text-sm text-gray-600">' +
          order.grain_details.map(g => `<li>${g.grain} - ${g.quantity} kg</li>`).join('') +
          '</ul>' : '';

      content.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <div class="flex items-center gap-2">${getOrderIconHTML(order)}</div>
          <div class="text-sm text-gray-600"><strong>Token:</strong> ${order.token_number || ''}</div>
        </div>
        <h2 class="text-xl font-bold mb-2">${order.customers?.name || 'N/A'}</h2>
        <p><strong>Phone:</strong> <a href="tel:${order.customers?.phone_number || ''}" class="text-blue-600 underline">${order.customers?.phone_number || 'N/A'}</a></p>
        <p><strong>Address:</strong> ${getFullAddress(order)}</p>
        <p class="mt-4 text-lg"><strong>Total:</strong> ₹${(order.total_price || 0).toFixed(2)}</p>
        ${grainsHTML}
        <p class="mt-2"><strong>Status:</strong> <span class="px-2 py-1 text-xs rounded ${getStatusClass(statusLabel)}">${statusLabel}</span></p>

        ${allowPickUp ? `
          <div class="mt-4">
            <button onclick="markPickedUp('${order.id}')" class="mt-2 w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700">Mark as Picked Up</button>
          </div>
        ` : ''}

        ${allowDeliver ? `
          <div class="mt-4">
            <p class="font-medium mb-2">Payment Method (if marking Delivered):</p>
            <label class="flex items-center gap-2 py-2">
              <input type="radio" name="payment_${order.id}" value="online"
                ${order.payment_status === 'online' ? 'checked' : ''}
                onchange="savePaymentMethod('${order.id}', this.value); document.getElementById('paymentError').classList.add('hidden');"/> Paid Online
            </label>
            <label class="flex items-center gap-2 py-2">
              <input type="radio" name="payment_${order.id}" value="cash"
                ${order.payment_status === 'cash' ? 'checked' : ''}
                onchange="savePaymentMethod('${order.id}', this.value); document.getElementById('paymentError').classList.add('hidden');"/> Paid Cash
            </label>
            <p id="paymentError" class="text-red-600 text-sm mt-2 hidden">⚠ Please select a payment method before marking as Delivered.</p>

            <button onclick="updateOrderStatus('${order.id}', '${getStatusIdByName('DELIVERED')}')"
              class="mt-4 w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
              Mark as Delivered
            </button>
          </div>
        ` : ''}

        ${(!allowDeliver && !allowPickUp) ? `<div class="mt-4 text-sm text-gray-500">This order cannot be updated from this screen.</div>` : ''}
      `;

      modal.classList.remove('hidden');
    }
    window.openModal = openModal;

    function closeModal() { document.getElementById('orderModal').classList.add('hidden'); }
    window.closeModal = closeModal;

    async function markPickedUp(orderId) {
      const pickedId = getStatusIdByName('PICKED UP');
      if (!pickedId) {
        alert('Could not resolve PICKED UP status id. Check statuses configuration.');
        return;
      }
      await supabase.from('orders').update({ status_id: pickedId }).eq('id', orderId);
      closeModal();
      await reloadOrders();
    }
    window.markPickedUp = markPickedUp;

    async function updateOrderStatus(orderId, newStatusId) {
      const nextStatus = statusesCache.find(s => s.id === newStatusId);
      if (!nextStatus) return;

      if (nextStatus.status_name === "DELIVERED") {
        const radios = document.querySelectorAll(`input[name="payment_${orderId}"]`);
        let selected = null;
        radios.forEach(r => { if (r.checked) selected = r.value; });

        if (!selected) {
          const err = document.getElementById("paymentError");
          if (err) err.classList.remove("hidden");
          return;
        }

        await supabase.from('orders').update({
          status_id: newStatusId,
          payment_status: selected,
          delivered_at: new Date().toISOString()
        }).eq('id', orderId);
      } else {
        await supabase.from('orders').update({ status_id: newStatusId }).eq('id', orderId);
      }

      closeModal();
      await reloadOrders();
    }
    window.updateOrderStatus = updateOrderStatus;

    async function savePaymentMethod(orderId, value) {
      await supabase.from('orders').update({ payment_status: value }).eq('id', orderId);
      await reloadOrders();
    }
    window.savePaymentMethod = savePaymentMethod;

    // Tab click handlers (set active class)
    function setActiveTab(tab) {
      currentTab = tab;
      document.getElementById('tabOpen').classList.toggle('active', tab === 'open');
      document.getElementById('tabOpen').setAttribute('aria-selected', tab === 'open');
      document.getElementById('tabPicked').classList.toggle('active', tab === 'picked');
      document.getElementById('tabPicked').setAttribute('aria-selected', tab === 'picked');
      document.getElementById('tabDelivered').classList.toggle('active', tab === 'delivered');
      document.getElementById('tabDelivered').setAttribute('aria-selected', tab === 'delivered');
      reloadOrders();
    }

    document.getElementById('tabOpen').addEventListener('click', () => setActiveTab('open'));
    document.getElementById('tabPicked').addEventListener('click', () => setActiveTab('picked'));
    document.getElementById('tabDelivered').addEventListener('click', () => setActiveTab('delivered'));

    async function init() {
      statusFlows = await buildStatusFlows();
      // initial tab style already set in markup
      await reloadOrders();
    }

    function debouncedReload() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => reloadOrders(), 300);
    }
    window.debouncedReload = debouncedReload;

    async function reloadOrders() {
      await fetchStatuses();
      await renderOrders();
    }
    window.reloadOrders = reloadOrders;

    // start
    await init();

  </script>
</body>
</html>
