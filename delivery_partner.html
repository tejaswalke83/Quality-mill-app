<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Delivery Partner - Orders</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    /* bigger icons */
    .order-icon { width: 28px; height: 28px; }
    .society-section { border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; }
  </style>
  <script defer src="/common.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <h1 class="text-2xl font-bold text-center mb-6">Delivery Partner — Orders</h1>

  <div class="max-w-5xl mx-auto">
    <!-- Tabs -->
    <div class="bg-white shadow rounded-lg p-4 mb-6">
      <div class="flex gap-2">
        <button id="tabOpen" class="px-4 py-2 bg-blue-500 text-white rounded">Open Orders</button>
        <button id="tabDelivered" class="px-4 py-2 bg-gray-100 rounded">Delivered</button>
      </div>
      <div class="mt-4 text-sm text-gray-600">
        Showing only home orders (home-milling &amp; home-buy-mill). Open shows "Out for delivery" and NEW home-milling orders.
      </div>
    </div>

    <!-- Filters / Search -->
    <div class="bg-white shadow rounded-lg p-4 mb-6">
      <div class="flex gap-3 items-center">
        <input id="searchBox" type="text"
               placeholder="Search by name, phone, token, address, society..."
               oninput="debouncedReload()" class="flex-1 border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
        <button onclick="reloadOrders()" class="px-4 py-2 bg-blue-500 text-white rounded">Refresh</button>
      </div>
    </div>

    <!-- Orders Container -->
    <div id="ordersContainer" class="space-y-4"></div>
  </div>

  <!-- Modal for status change -->
  <div id="orderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg max-w-lg w-full p-6 relative">
      <button onclick="closeModal()" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700">✖</button>
      <div id="modalContent"></div>
    </div>
  </div>

  <script src="config.js"></script>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Supabase credentials (from your config.js)
    const SUPABASE_URL = window._env_?.SUPABASE_URL;
    const SUPABASE_KEY = window._env_?.SUPABASE_ANON_KEY;
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // OpenMoji icons (color)
    const PINWHEEL_URL = "https://openmoji.org/data/color/svg/269B.svg";
    const SCOOTER_URL = "https://openmoji.org/data/color/svg/1F6F5.svg";

    let statusesCache = [];
    let statusFlows = {};
    let currentTab = 'open';
    let searchTimeout;

    /* ------------------------
       Helpers: status class + icon HTML
       ------------------------ */
    function getStatusClass(status) {
      const map = {
        "NEW": "bg-yellow-100 text-yellow-800",
        "IN PROCESS": "bg-blue-100 text-blue-800",
        "MILLING COMPLETED": "bg-green-100 text-green-800",
        "DELIVERED": "bg-gray-200 text-gray-800",
        "PICKED UP": "bg-purple-100 text-purple-800",
        "RECEIVED AT MILL": "bg-orange-100 text-orange-800",
        "OUT FOR DELIVERY": "bg-pink-100 text-pink-800"
      };
      return map[status] || "bg-gray-100 text-gray-700";
    }

    function getOrderIconHTML(order) {
      const pin = `<img src="${PINWHEEL_URL}" class="order-icon inline-block mr-2" />`;
      const scoot = `<img src="${SCOOTER_URL}" class="order-icon inline-block mr-2" />`;
      if (order.order_type === 'shop-buy-mill') return pin;
      if (order.order_type === 'home-milling') return scoot;
      if (order.order_type === 'home-buy-mill') return pin + scoot;
      return '';
    }

    /* ------------------------
       Fetch statuses and build flows
       ------------------------ */
    async function fetchStatuses() {
      const { data, error } = await supabase.from('order_statuses').select('*').order('sort_order', { ascending: true });
      if (error) {
        console.error('fetchStatuses:', error);
        statusesCache = [];
      } else statusesCache = data || [];
      return statusesCache;
    }

    async function buildStatusFlows() {
      await fetchStatuses();
      const statusMap = {};
      statusesCache.forEach(s => statusMap[s.status_name] = s.id);

      return {
        "shop-milling": [statusMap["NEW"], statusMap["IN PROCESS"], statusMap["MILLING COMPLETED"], statusMap["DELIVERED"]],
        "shop-buy-mill": [statusMap["NEW"], statusMap["IN PROCESS"], statusMap["MILLING COMPLETED"], statusMap["DELIVERED"]],
        "home-milling": [statusMap["NEW"], statusMap["PICKED UP"], statusMap["RECEIVED AT MILL"], statusMap["IN PROCESS"], statusMap["MILLING COMPLETED"], statusMap["OUT FOR DELIVERY"], statusMap["DELIVERED"]],
        "home-buy-mill": [statusMap["NEW"], statusMap["IN PROCESS"], statusMap["MILLING COMPLETED"], statusMap["OUT FOR DELIVERY"], statusMap["DELIVERED"]]
      };
    }

    function getNextStatus(order) {
      const flow = statusFlows[order.order_type] || [];
      const idx = flow.indexOf(order.status_id);
      if (idx === -1 || idx + 1 >= flow.length) return null;
      return statusesCache.find(s => s.id === flow[idx + 1]) || null;
    }

    /* ------------------------
       Robust getStatusIdByName (live first, then fallback UUIDs)
       ------------------------ */
    function getStatusIdByName(name) {
      if (!name) return null;
      const normalized = name.toString().trim().toUpperCase();

      // 1) prefer live cache
      const live = statusesCache.find(x => (x.status_name || '').toUpperCase() === normalized);
      if (live) return live.id;

      // 2) fallback UUIDs captured from your screenshot
      const fallback = {
        'NEW': '465bf226-1312-4708-a99e-bf90e400f7e0',
        'PICKED UP': '24cd0820-1735-4017-aeaf-9463c08820f6',
        'RECEIVED AT MILL': '15b2a302-64f4-4fdf-b021-be497f2b38f3',
        'IN PROCESS': 'c1dd1b37-62c4-46f5-a134-b50a7ca66588',
        'MILLING COMPLETED': 'a396305a-8b27-4d5d-b3ce-408fb875d29',
        'OUT FOR DELIVERY': '0b7136c4-1392-40df-bd1a-20df5df98656',
        'DELIVERED': 'a8909616-20ad-44f3-9d78-bc2b22ccd60',
        // note: keep exact spelling from your screenshot
        'ARCHIEVED': '9a30f2df-199d-439f-9fef-9dbd088be84a'
      };
      return fallback[normalized] || null;
    }

    /* ------------------------
       Data fetching (robust)
       ------------------------ */
    async function fetchOrdersFromDB() {
      // Request all customer columns to avoid "column does not exist" SQL errors
      const { data, error } = await supabase
        .from('orders')
        .select(`
          *,
          customers(*),
          order_statuses(status_name, sort_order, id)
        `)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('fetchOrdersFromDB:', error);
        const container = document.getElementById('ordersContainer') || document.getElementById('ordersList');
        if (container) {
          container.innerHTML = '';
          const errEl = document.createElement('div');
          errEl.className = 'text-red-600 text-sm p-3';
          errEl.textContent = `Error fetching orders: ${error.message || error.code || 'unknown'}`;
          container.appendChild(errEl);
        }
        return [];
      }

      // debug: inspect first row (remove after debugging)
      if (Array.isArray(data) && data.length > 0) {
        console.log('DEBUG: sample order[0]:', data[0]);
        console.log('DEBUG: sample customer object:', data[0].customers);
      } else {
        console.log('DEBUG: no orders returned from DB');
      }

      return data || [];
    }

    /* ------------------------
       Utilities: address & society detection (defensive)
       ------------------------ */
    function getFullAddress(order) {
      const c = order.customers || {};
      const parts = [];

      // Known / common top-level fields
      if (c.address_line) parts.push(c.address_line);
      if (c.address) {
        if (typeof c.address === 'string') {
          parts.push(c.address);
        } else if (typeof c.address === 'object') {
          if (c.address.line1) parts.push(c.address.line1);
          if (c.address.line2) parts.push(c.address.line2);
          if (c.address.street) parts.push(c.address.street);
          if (c.address.locality) parts.push(c.address.locality);
          if (c.address.society) parts.push(c.address.society);
          if (c.address.socity) parts.push(c.address.socity); // common typo
          if (c.address.city) parts.push(c.address.city);
          if (c.address.state) parts.push(c.address.state);
          if (c.address.pincode) parts.push(c.address.pincode);
        }
      }

      // fallback top-level fields
      if (c.street) parts.push(c.street);
      if (c.city) parts.push(c.city);
      if (c.state) parts.push(c.state);
      if (c.pincode) parts.push(c.pincode);
      if (c.zip) parts.push(c.zip);
      if (c.postal_code) parts.push(c.postal_code);

      // last resort: join whatever metadata exists
      if (c.metadata && typeof c.metadata === 'object') {
        if (c.metadata.address) parts.push(c.metadata.address);
        if (c.metadata.locality) parts.push(c.metadata.locality);
      }

      return parts.filter(Boolean).join(', ') || 'Address not available';
    }

    function getSocietyName(order) {
      const c = order.customers || {};
      return c.society || c.society_name || c.societyId || c.society_id ||
             (c.address && (c.address.society || c.address.locality || c.address.socity)) ||
             (c.metadata && (c.metadata.society || c.metadata.locality)) ||
             "Other";
    }

    /* ------------------------
       Render logic (grouped by society)
       ------------------------ */
    async function renderOrders() {
      await fetchStatuses();
      const all = await fetchOrdersFromDB();

      // Filter only home order types
      const homeOrders = all.filter(o => ['home-milling','home-buy-mill'].includes(o.order_type));

      // Partition open & delivered according to your rule
      const openOrders = homeOrders.filter(o => {
        const statusObj = statusesCache.find(s => s.id === o.status_id) || {};
        const statusName = (statusObj.status_name || '').toUpperCase();
        if (statusName === "OUT FOR DELIVERY") return true;
        if (statusName === "NEW" && o.order_type === "home-milling") return true;
        return false;
      });

      const deliveredOrders = homeOrders.filter(o => {
        const statusObj = statusesCache.find(s => s.id === o.status_id) || {};
        const statusName = (statusObj.status_name || '').toUpperCase();
        return statusName === "DELIVERED";
      });

      const searchTerm = (document.getElementById('searchBox').value || '').toLowerCase().trim();

      const filteredOpen = openOrders.filter(o => {
        if (!searchTerm) return true;
        const name = (o.customers?.name || '').toLowerCase();
        const phone = String(o.customers?.phone_number || '').toLowerCase();
        const token = String(o.token_number || '').toLowerCase();
        const total = String(o.total_price || '').toLowerCase();
        const addr = getFullAddress(o).toLowerCase();
        const society = getSocietyName(o).toLowerCase();
        const statusName = (statusesCache.find(s => s.id === o.status_id)?.status_name || '').toLowerCase();

        return name.includes(searchTerm) || phone.includes(searchTerm) || token.includes(searchTerm) ||
               total.includes(searchTerm) || addr.includes(searchTerm) || society.includes(searchTerm) ||
               statusName.includes(searchTerm);
      });

      const filteredDelivered = deliveredOrders.filter(o => {
        if (!searchTerm) return true;
        const name = (o.customers?.name || '').toLowerCase();
        const phone = String(o.customers?.phone_number || '').toLowerCase();
        const token = String(o.token_number || '').toLowerCase();
        const total = String(o.total_price || '').toLowerCase();
        const addr = getFullAddress(o).toLowerCase();
        const society = getSocietyName(o).toLowerCase();
        const statusName = (statusesCache.find(s => s.id === o.status_id)?.status_name || '').toLowerCase();

        return name.includes(searchTerm) || phone.includes(searchTerm) || token.includes(searchTerm) ||
               total.includes(searchTerm) || addr.includes(searchTerm) || society.includes(searchTerm) ||
               statusName.includes(searchTerm);
      });

      const container = document.getElementById('ordersContainer');
      container.innerHTML = '';

      if (currentTab === 'open') {
        if (filteredOpen.length === 0) {
          container.innerHTML = '<p class="text-gray-500">No open orders found.</p>';
          return;
        }

        // group by society
        const groups = {};
        filteredOpen.forEach(o => {
          const s = getSocietyName(o);
          groups[s] = groups[s] || [];
          groups[s].push(o);
        });

        Object.keys(groups).forEach(soc => {
          const section = document.createElement('div');
          section.className = 'society-section bg-white p-4 shadow rounded-lg mb-4';
          const hdr = document.createElement('div');
          hdr.className = 'flex justify-between items-center mb-3';
          hdr.innerHTML = `<div class="font-semibold">${soc} <span class="text-sm text-gray-500">(${groups[soc].length})</span></div>`;
          section.appendChild(hdr);

          groups[soc].forEach(order => {
            const statusObj = statusesCache.find(s => s.id === order.status_id);
            const statusLabel = statusObj ? statusObj.status_name : 'Unknown';
            const statusClass = getStatusClass(statusLabel);

            const card = document.createElement('div');
            card.className = 'order-card bg-gray-50 rounded p-3 mb-3 hover:shadow cursor-pointer';
            card.innerHTML = `
              <div class="flex justify-between items-start gap-3">
                <div class="flex items-start gap-3">
                  ${getOrderIconHTML(order)}
                  <div>
                    <h3 class="font-semibold">${order.customers?.name || 'N/A'}</h3>
                    <p class="text-sm text-gray-600">Token: ${order.token_number || ''} • ${window.convertUTCToIST ? window.convertUTCToIST(order.created_at) : order.created_at}</p>
                    <p class="text-sm"><strong>Phone:</strong> <a href="tel:${order.customers?.phone_number || ''}" class="text-blue-600 underline">${order.customers?.phone_number || 'N/A'}</a></p>
                    <p class="text-sm mt-1"><strong>Address:</strong> ${getFullAddress(order)}</p>
                    <p class="text-sm mt-1"><strong>Total:</strong> ₹${(order.total_price||0).toFixed(2)}</p>
                  </div>
                </div>

                <div class="text-right">
                  <div class="mb-2"><span class="px-2 py-1 text-xs rounded ${statusClass}">${statusLabel}</span></div>
                  <div class="text-sm text-gray-600">${order.payment_status || 'Not Paid'}</div>
                </div>
              </div>
            `;
            card.addEventListener('click', () => openModal(order));
            section.appendChild(card);
          });

          container.appendChild(section);
        });

      } else { // delivered tab
        if (filteredDelivered.length === 0) {
          container.innerHTML = '<p class="text-gray-500">No delivered orders yet.</p>';
          return;
        }

        const groups = {};
        filteredDelivered.forEach(o => {
          const s = getSocietyName(o);
          groups[s] = groups[s] || [];
          groups[s].push(o);
        });

        Object.keys(groups).forEach(soc => {
          const section = document.createElement('div');
          section.className = 'society-section bg-white p-4 shadow rounded-lg mb-4';
          const hdr = document.createElement('div');
          hdr.className = 'flex justify-between items-center mb-3';
          hdr.innerHTML = `<div class="font-semibold">${soc} <span class="text-sm text-gray-500">(${groups[soc].length})</span></div>`;
          section.appendChild(hdr);

          groups[soc].forEach(order => {
            const statusObj = statusesCache.find(s => s.id === order.status_id);
            const statusLabel = statusObj ? statusObj.status_name : 'Unknown';
            const statusClass = getStatusClass(statusLabel);

            const card = document.createElement('div');
            card.className = 'order-card bg-gray-50 rounded p-3 mb-3';
            card.innerHTML = `
              <div class="flex justify-between items-start gap-3">
                <div class="flex items-start gap-3">
                  ${getOrderIconHTML(order)}
                  <div>
                    <h3 class="font-semibold">${order.customers?.name || 'N/A'}</h3>
                    <p class="text-sm text-gray-600">Token: ${order.token_number || ''} • ${window.convertUTCToIST ? window.convertUTCToIST(order.created_at) : order.created_at}</p>
                    <p class="text-sm"><strong>Phone:</strong> <a href="tel:${order.customers?.phone_number || ''}" class="text-blue-600 underline">${order.customers?.phone_number || 'N/A'}</a></p>
                    <p class="text-sm mt-1"><strong>Address:</strong> ${getFullAddress(order)}</p>
                    <p class="text-sm mt-1"><strong>Total:</strong> ₹${(order.total_price||0).toFixed(2)}</p>
                  </div>
                </div>

                <div class="text-right">
                  <div class="mb-2"><span class="px-2 py-1 text-xs rounded ${statusClass}">${statusLabel}</span></div>
                  <div class="text-sm text-gray-600">${order.payment_status || 'Not Paid'}</div>
                </div>
              </div>
            `;
            // delivered entries are read-only
            section.appendChild(card);
          });

          container.appendChild(section);
        });
      }
    }

    /* ------------------------
       Modal for marking delivered
       ------------------------ */
    function openModal(order) {
      const modal = document.getElementById("orderModal");
      const content = document.getElementById("modalContent");
      const statusObj = statusesCache.find(s => s.id === order.status_id);
      const statusLabel = statusObj ? statusObj.status_name : 'Unknown';
      const next = getNextStatus(order);
      // allow marking delivered if currently OUT FOR DELIVERY or next is DELIVERED
      const allowDeliver = (statusLabel.toUpperCase() === "OUT FOR DELIVERY") || (next && next.status_name === "DELIVERED");

      const grainsHTML = Array.isArray(order.grain_details)
        ? '<ul class="list-disc ml-6 text-sm text-gray-600">' +
          order.grain_details.map(g => `<li>${g.grain} - ${g.quantity} kg</li>`).join('') +
          '</ul>' : '';

      content.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <div class="flex items-center gap-2">${getOrderIconHTML(order)}</div>
          <div class="text-sm text-gray-600"><strong>Token:</strong> ${order.token_number || ''}</div>
        </div>
        <h2 class="text-xl font-bold mb-2">${order.customers?.name || 'N/A'}</h2>
        <p><strong>Phone:</strong> <a href="tel:${order.customers?.phone_number || ''}" class="text-blue-600 underline">${order.customers?.phone_number || 'N/A'}</a></p>
        <p><strong>Address:</strong> ${getFullAddress(order)}</p>
        <p class="mt-4 text-lg"><strong>Total:</strong> ₹${(order.total_price || 0).toFixed(2)}</p>
        ${grainsHTML}
        <p class="mt-2"><strong>Status:</strong> <span class="px-2 py-1 text-xs rounded ${getStatusClass(statusLabel)}">${statusLabel}</span></p>

        ${allowDeliver ? `
          <div class="mt-4">
            <p class="font-medium mb-2">Payment Method (if marking Delivered):</p>
            <label class="flex items-center gap-2 py-2">
              <input type="radio" name="payment_${order.id}" value="online"
                ${order.payment_status === 'online' ? 'checked' : ''}
                onchange="savePaymentMethod('${order.id}', this.value); document.getElementById('paymentError').classList.add('hidden');"/> Paid Online
            </label>
            <label class="flex items-center gap-2 py-2">
              <input type="radio" name="payment_${order.id}" value="cash"
                ${order.payment_status === 'cash' ? 'checked' : ''}
                onchange="savePaymentMethod('${order.id}', this.value); document.getElementById('paymentError').classList.add('hidden');"/> Paid Cash
            </label>
            <p id="paymentError" class="text-red-600 text-sm mt-2 hidden">⚠ Please select a payment method before marking as Delivered.</p>
          </div>
          <button onclick="updateOrderStatus('${order.id}', '${getStatusIdByName('DELIVERED')}')"
            class="mt-4 w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
            Mark as Delivered
          </button>
        ` : `
          <div class="mt-4 text-sm text-gray-500">This order cannot be updated from this screen.</div>
        `}
      `;
      modal.classList.remove('hidden');
    }
    window.openModal = openModal;

    function closeModal() { document.getElementById('orderModal').classList.add('hidden'); }
    window.closeModal = closeModal;

    /* ------------------------
       Update status & payment helpers
       ------------------------ */
    async function updateOrderStatus(orderId, newStatusId) {
      const nextStatus = statusesCache.find(s => s.id === newStatusId);
      if (!nextStatus) return;

      if (nextStatus.status_name === "DELIVERED") {
        const radios = document.querySelectorAll(`input[name="payment_${orderId}"]`);
        let selected = null;
        radios.forEach(r => { if (r.checked) selected = r.value; });

        if (!selected) {
          const err = document.getElementById("paymentError");
          if (err) err.classList.remove("hidden");
          return;
        }

        await supabase.from('orders').update({
          status_id: newStatusId,
          payment_status: selected,
          delivered_at: new Date().toISOString()
        }).eq('id', orderId);
      } else {
        await supabase.from('orders').update({ status_id: newStatusId }).eq('id', orderId);
      }

      closeModal();
      await reloadOrders();
    }
    window.updateOrderStatus = updateOrderStatus;

    async function savePaymentMethod(orderId, value) {
      await supabase.from('orders').update({ payment_status: value }).eq('id', orderId);
      await reloadOrders();
    }
    window.savePaymentMethod = savePaymentMethod;

    /* ------------------------
       Tabs & init
       ------------------------ */
    document.getElementById('tabOpen').addEventListener('click', () => {
      currentTab = 'open';
      document.getElementById('tabOpen').classList.add('bg-blue-500','text-white');
      document.getElementById('tabDelivered').classList.remove('bg-blue-500','text-white');
      reloadOrders();
    });
    document.getElementById('tabDelivered').addEventListener('click', () => {
      currentTab = 'delivered';
      document.getElementById('tabDelivered').classList.add('bg-blue-500','text-white');
      document.getElementById('tabOpen').classList.remove('bg-blue-500','text-white');
      reloadOrders();
    });

    async function init() {
      statusFlows = await buildStatusFlows();
      // initial tab style
      if (currentTab === 'open') document.getElementById('tabOpen').classList.add('bg-blue-500','text-white');
      await reloadOrders();
    }

    function debouncedReload() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => reloadOrders(), 300);
    }
    window.debouncedReload = debouncedReload;

    async function reloadOrders() {
      await fetchStatuses();
      await renderOrders();
    }
    window.reloadOrders = reloadOrders;

    // start
    await init();

  </script>
</body>
</html>
