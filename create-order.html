<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Create Order</title>
<style>
body {
font-family: Arial, sans-serif;
background-color: #e6f0ff;
padding: 20px;
}

.card {
background: white;
padding: 20px;
border-radius: 12px;
max-width: 700px;
margin: auto;
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

h2 {
text-align: center;
color: #1a73e8;
}

.row {
display: flex;
align-items: center;
gap: 10px;
margin-bottom: 10px;
flex-wrap: wrap;
}

select {
padding: 6px;
border-radius: 6px;
border: 1px solid #ccc;
flex: 1;
min-width: 120px;
}

input[type="number"] {
padding: 6px;
border-radius: 6px;
border: 1px solid #ccc;
width: 80px;
}

.price, .total {
min-width: 80px;
}

.error {
color: red;
font-size: 0.85em;
flex: 1 1 100%;
}

button {
background-color: #1a73e8;
color: white;
border: none;
padding: 10px 16px;
border-radius: 8px;
cursor: pointer;
}

button:hover {
background-color: #155ab6;
}

.outlined {
background: transparent;
border: 2px solid #1a73e8;
color: #1a73e8;
}

.outlined:hover {
background: #e6f0ff;
}

.total-section {
text-align: right;
margin-top: 20px;
font-weight: bold;
font-size: 1.1em;
}

.actions {
text-align: center;
margin-top: 20px;
}

.remove-btn {
border: 2px solid red;
background: transparent;
color: red;
padding: 6px 10px;
border-radius: 6px;
cursor: pointer;
}

.remove-btn:hover {
background-color: #ffe6e6;
}

.remove-btn::after {
content: "-";
font-size: 16px;
}
</style>

</head>
<body>



<p>You selected: <span id="selectedService"></span></p>



<div class="card">
<h2>Create New Order</h2>

<div id="user-info"></div>
<hr><br>

<div id="order-rows"></div>



<button class="outlined" onclick="addRow()">+ Add Grain </button>

<!-- Pricing Breakdown (hidden until we have numbers) -->
<div id="pricing-card" class="card" style="margin-top:20px; display:none;">
  <div style="display:flex; align-items:center; justify-content:space-between;">
    <h3 style="margin:0;">Pricing Breakdown</h3>
    <div id="total-amount" style="font-weight:700;">â‚¹0.00</div>
  </div>
  <hr>
  <div class="row" style="justify-content:space-between;">
    <span>Grain Cost</span><span id="grain-cost">â‚¹0.00</span>
  </div>
  <div class="row" style="justify-content:space-between;">
    <span>Billing Charges</span><span id="billing-cost">â‚¹0.00</span>
  </div>
  <div class="row" id="delivery-row" style="justify-content:space-between; display:none;">
    <span>Delivery Charges</span><span id="delivery-cost">â‚¹0.00</span>
  </div>
  <hr>
  <div class="row" style="justify-content:space-between; font-weight:700;">
    <span>Total Amount</span><span id="final-total">â‚¹0.00</span>
  </div>
</div>


<br> <hr>
<div class="total-section">
Total Price: â‚¹<span id="total-price">0</span>
</div>

<div class="actions">
<button onclick="submitOrder()">Submit Order</button>
<button onclick="window.location.href='user reg.html'">Cancel</button>
</div>
</div>


</div>
<script src="script.js"></script>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabase = createClient('https://odczzymxgjsjhbufffxm.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kY3p6eW14Z2pzamhidWZmZnhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMjY2NDIsImV4cCI6MjA2OTkwMjY0Mn0.T2ZT6U11taDH7vNTUJgI9xvqEZ1YEfBrNx28QV7jJvI');
const urlParams = new URLSearchParams(window.location.search);
const phone = urlParams.get('phone');

let grainList = [];
let user = null;

const orderRows = document.getElementById('order-rows');
const totalPriceEl = document.getElementById('total-price');



document.addEventListener("DOMContentLoaded", () => {
  const service = localStorage.getItem("orderService");
  if (service) {
    document.getElementById("selectedService").textContent = service;
  }
});




async function generateTokenNumber() {
    console.log("generateTokenNumber() called");

    // Get all active (non-completed) token numbers
    const { data: activeOrders, error } = await supabase
        .from('orders')
        .select('token_number')
        .not('status', 'eq', 'completed');

    if (error) {
        console.error("Error fetching active orders:", error);
        throw error;
    }

    const activeTokens = new Set((activeOrders || []).map(o => o.token_number));

    // Find the last issued token number (numerically)
    let maxTokenNum = 0;
    activeTokens.forEach(token => {
        const num = parseInt(token.slice(2), 10); // remove "QA" and parse number
        if (num > maxTokenNum) maxTokenNum = num;
    });

    // Try the next token number
    for (let attempt = 1; attempt <= 999; attempt++) {
        let nextNum = maxTokenNum + attempt;
        if (nextNum > 999) nextNum -= 999; // wrap around after QA999

        const padded = nextNum.toString().padStart(3, '0');
        const token = `QA${padded}`;

        if (!activeTokens.has(token)) {
            console.log("Token generated:", token);
            return token;
        }
    }

    throw new Error("All token numbers are in use.");
}


async function fetchData() {
  // Get user by phone
  const { data, error } = await supabase
    .from('customers')
    .select('*')
    .eq('phone_number', phone)
    .maybeSingle();

  if (!data) {
    document.getElementById('user-info').innerHTML = `<p style="color:red;">Customer not found!</p>`;
    return;
  }

  user = data;
 const service = localStorage.getItem("orderType") || localStorage.getItem("orderService") || "";
  document.getElementById('user-info').innerHTML = `
  <p><strong>Name:</strong> ${user.name}</p>
  <p><strong>Mobile:</strong> ${user.phone_number}</p>
  <p><strong>Flat:</strong> ${user.flat_number}, ${user.wing}</p>
  <p><strong>Society:</strong> ${user.society_name}</p>
  <p><strong>Order Type:</strong> <span id="selectedService">${service || "-"}</span></p>
  `;

  //localStorage.setItem('orderType', type);
  // âœ… Check service type
  // const service = localStorage.getItem("orderType");

  console.error('Service --> :', service);

  await fetchDeliveryChargeIfNeeded();

  
  // Hide manual "Add Grain" + old total when this is a Buy+Mill flow
  if (service && service.toLowerCase().includes("buy")) {
  const addBtn = document.querySelector(".outlined");
  if (addBtn) addBtn.style.display = "none";
  const oldTotal = document.querySelector(".total-section");
  if (oldTotal) oldTotal.style.display = "none";
  }

}

// -----------------------
// For Milling Service
// -----------------------
async function loadMillingGrains() {
  const { data: grains } = await supabase.from('grain_prices').select('*');
  grainList = grains;

  // Add default row
  addRow();
}


// -----------------------
// For Buy + Mill Service
// -----------------------
async function loadGrainsForSell() {
  const { data: grains, error } = await supabase
    .from('Grain_for_sell')
    .select('*');

      console.error('grains --> :', grains);

  if (error) {
    console.error(error);
    return;
  }

  row.innerHTML = `
  <input type="checkbox" class="grain-check" ${disabled} />
  <div style="flex:2;">
    <strong class="g-name">${g.grain_name}</strong><br>
    <span class="g-price" data-price="${Number(g.price_per_kg)}">Price: â‚¹${Number(g.price_per_kg).toFixed(2)}/kg</span><br>
    ${g.stock_qty > 0 
      ? `Stock: ${g.stock_qty} kg` 
      : `<span style="color:red;">Not in stock</span>`}
  </div>
  <input type="number" min="1" max="${g.stock_qty}" placeholder="Qty (kg)" 
    class="grain-qty" ${disabled} style="width:80px;" />
  <div class="total">â‚¹<span>0</span></div>
  <div class="error" style="flex-basis:100%; color:red;"></div>
`;


  grains.forEach(g => {
    const row = document.createElement("div");
    row.className = "row";
    row.style.border = "1px solid #ccc";
    row.style.padding = "12px";
    row.style.borderRadius = "8px";
    row.style.boxShadow = "0 2px 5px rgba(0, 0, 0, 0.05)";
    row.style.marginBottom = "12px";
    row.style.display = "flex";
    row.style.flexWrap = "wrap";
    row.style.alignItems = "center";
    row.style.gap = "10px";

    const disabled = g.stock <= 0 ? "disabled" : "";

    row.innerHTML = `
      <input type="checkbox" class="grain-check" ${disabled} />
      <div style="flex:2;">
        <strong>${g.grain_name}</strong><br>
        Price: â‚¹${g.price_per_kg}/kg <br>
        ${g.stock_qty > 0 
          ? `Stock: ${g.stock_qty} kg` 
          : `<span style="color:red;">Not in stock</span>`}
      </div>
      <input type="number" min="1" max="${g.stock_}" placeholder="Qty (kg)" 
        class="grain-qty" ${disabled} style="width:80px;" />
      <div class="total">â‚¹<span>0</span></div>
    `;

    orderRows.appendChild(row);
  });

  // Listen for changes
  orderRows.addEventListener("input", updateBuyAndMillTotal);
  orderRows.addEventListener("change", updateBuyAndMillTotal);

  // Show total also at top
  // const totalTop = document.createElement("div");
  // totalTop.className = "total-section";
  // totalTop.innerHTML = `Total Price: â‚¹<span id="total-price-top">0</span>`;
  // orderRows.prepend(totalTop);
}



// Auto-check when qty is typed
orderRows.addEventListener("input", (e) => {
  if (!e.target.classList.contains("grain-qty")) return;
  const row = e.target.closest(".row");
  const check = row.querySelector(".grain-check");
  const err = row.querySelector(".error");
  const qty = Number(e.target.value || 0);
  if (qty > 0) {
    check.checked = true;
    if (err) err.textContent = "";
  } else {
    check.checked = false;
  }
  updateBuyAndMillTotal();
});

// Block checking if qty is empty
orderRows.addEventListener("change", (e) => {
  if (!e.target.classList.contains("grain-check")) return;
  const row = e.target.closest(".row");
  const qty = Number(row.querySelector(".grain-qty").value || 0);
  const err = row.querySelector(".error");
  if (e.target.checked && qty <= 0) {
    e.target.checked = false;
    if (err) err.textContent = "Please enter the quantity";
  } else if (err) {
    err.textContent = "";
  }
  function getMillingRateByName(name) {
  const n = (name || "").toLowerCase();
  if (n.includes("dal")) return 8;
  if (n.includes("wheat") || n.includes("lokwan") || n.includes("jowar") || n.includes("bajra")) return 6;
  // default
  return 6;
}

  updateBuyAndMillTotal();
});



// -----------------------
// Update Totals for Buy + Mill
// -----------------------
function updateBuyAndMillTotal() {
  let grainCost = 0;
  let billingCost = 0;

  const rows = [...orderRows.querySelectorAll(".row")];

  rows.forEach(row => {
    const check = row.querySelector(".grain-check");
    const qtyInput = row.querySelector(".grain-qty");
    const totalEl = row.querySelector(".total span");
    const name = row.querySelector(".g-name")?.textContent || "";
    const price = Number(row.querySelector(".g-price")?.dataset.price || 0);
    const qty = Number(qtyInput?.value || 0);

    if (!check || !qtyInput || !totalEl) return;

    if (!check.checked || qty <= 0) {
      totalEl.textContent = "0";
      return;
    }

    const rowGrainCost = price * qty;         // grain purchase price
    const rate = getMillingRateByName(name);  // milling (billing) per kg
    const rowBilling = rate * qty;

    totalEl.textContent = (rowGrainCost + rowBilling).toFixed(2); // per-row display (optional)

    grainCost += rowGrainCost;
    billingCost += rowBilling;
  });

  // Delivery (already fetched when needed)
  const total = grainCost + billingCost + deliveryCharge;

  // Show the pricing card and fill values
  const card = document.getElementById("pricing-card");
  if (card) card.style.display = "block";

  document.getElementById("grain-cost").textContent = `â‚¹${grainCost.toFixed(2)}`;
  document.getElementById("billing-cost").textContent = `â‚¹${billingCost.toFixed(2)}`;
  if (document.getElementById("delivery-row").style.display !== "none") {
    document.getElementById("delivery-cost").textContent = `â‚¹${deliveryCharge.toFixed(2)}`;
  }
  document.getElementById("final-total").textContent = `â‚¹${total.toFixed(2)}`;
  document.getElementById("total-amount").textContent = `â‚¹${total.toFixed(2)}`;

  // Keep old total element (not shown in Buy+Mill) in sync just in case
  const legacy = document.getElementById("total-price");
  if (legacy) legacy.textContent = total.toFixed(2);
}




window.addRow = function () {
     console.log("in submit order 2:");
const row = document.createElement('div');
row.className = 'row';
row.style.marginBottom = "12px";

// Card-like styling
row.style.border = "1px solid #ccc";
row.style.padding = "12px";
row.style.borderRadius = "8px";
row.style.boxShadow = "0 2px 5px rgba(0, 0, 0, 0.05)";
row.style.display = "flex";
row.style.flexWrap = "wrap";
row.style.gap = "10px";
row.style.alignItems = "center";

row.innerHTML = `
  <select onchange="updatePrice(this)" style="flex: 2; min-width: 150px; font-size: 16px; padding: 6px;">

     <option value="">Select Grain</option>
     ${grainList.map(g => `<option value="${g.grain}" data-price="${g.price}">${g.grain}</option>`).join('')}
   </select>

   <input type="number" min="1" placeholder="Quantity (kg)" oninput="updateTotal()" style="flex: 1; min-width: 80px;" />

   <div class="total">â‚¹<span>0</span></div>

   <button class="remove-btn" onclick="this.parentElement.remove(); updateTotal();" 
     style="border: 1px solid red; background: transparent; color: red; padding: 4px 8px; border-radius: 4px;">
     <i class="fas fa-trash-alt"></i>
   </button>

   <div class="error" style="flex-basis: 100%; color: red;"></div>
 `;

orderRows.appendChild(row);
}


window.updatePrice = function (selectElement) {
const selectedOption = selectElement.options[selectElement.selectedIndex];
const price = parseFloat(selectedOption.getAttribute('data-price')) || 0;

const row = selectElement.closest('.row');

const quantityInput = row.querySelector('input[type="number"]');
const totalEl = row.querySelector('.total span');

const quantity = parseFloat(quantityInput.value) || 0;
const total = price * quantity;

totalEl.textContent = total.toFixed(2);

// âœ… No attempt to update price per kg element (since it's removed)
}



window.updateTotal = function() {
  console.log("in update total :");
    
let grandTotal = 0;
[...orderRows.children].forEach(row => {
const select = row.querySelector('select');
const qtyInput = row.querySelector('input');
const price = parseFloat(select.selectedOptions[0]?.dataset.price || 0);
const qty = parseFloat(qtyInput.value || 0);
const rowTotal = price * qty;
row.querySelector('.total span').textContent = rowTotal.toFixed(2);
grandTotal += rowTotal;
});
totalPriceEl.textContent = grandTotal.toFixed(2);
}
function getCurrentTotalForSubmit() {
  const card = document.getElementById("pricing-card");
  if (card && card.style.display !== "none") {
    const v = Number((document.getElementById("final-total")?.textContent || "0").replace(/[^\d.]/g, ""));
    return isNaN(v) ? 0 : v;
  }
  // fallback to old total-section
  const legacy = Number((document.getElementById("total-price")?.textContent || "0").replace(/[^\d.]/g, ""));
  return isNaN(legacy) ? 0 : legacy;
}

window.submitOrder = async function () {
  console.log("in submit order :");

  const service = localStorage.getItem("orderType");
  let grainDetails = [];
  let hasError = false;

  // ---------------------------
  // 1. Collect Grain Details
  // ---------------------------
  if (service && service.toLowerCase().includes("buy")) {
    // ðŸ‘‰ Buy + Mill Flow
    const rows = [...orderRows.querySelectorAll(".row")];
    rows.forEach(row => {
      const check = row.querySelector(".grain-check");
      const qtyInput = row.querySelector(".grain-qty");
      if (!check.checked) return; // skip if not selected

      const name = row.querySelector("strong").textContent;
      const priceMatch = row.innerHTML.match(/â‚¹(\d+)/);
      const price = priceMatch ? parseFloat(priceMatch[1]) : 0;
      const qty = parseFloat(qtyInput.value || 0);

      if (qty <= 0) {
        row.style.border = "2px solid red";
        hasError = true;
      } else {
        row.style.border = "1px solid #ccc";
      }

      grainDetails.push({
        grain: name,
        quantity: qty,
        price,
        total: price * qty
      });
    });
  } else {
    // ðŸ‘‰ Milling Flow (your old logic)
    const rows = [...orderRows.children];
    rows.forEach(row => {
      const select = row.querySelector('select');
      const qtyInput = row.querySelector('input');
      const errorEl = row.querySelector('.error');
      errorEl.textContent = '';

      const grain = select.value;
      const price = parseFloat(select.selectedOptions[0]?.dataset.price || 0);
      const qty = parseFloat(qtyInput.value || 0);

      if (!grain || qty <= 0) {
        errorEl.textContent = "Select grain and enter valid quantity.";
        hasError = true;
        return;
      }

      grainDetails.push({
        grain,
        quantity: qty,
        price,
        total: price * qty
      });
    });
  }

  // ---------------------------
  // 2. Stop if error
  // ---------------------------
  if (hasError || grainDetails.length === 0) {
    alert("Please fix errors before submitting.");
    return;
  }

  // ---------------------------
  // 3. Calculate Total
  // ---------------------------
 const total_price = getCurrentTotalForSubmit();


  try {
    // âœ… Generate token number FIRST
    console.log("About to generate token...");
    const token_number = await generateTokenNumber();
    console.log(" token generated " + token_number);

    // âœ… Insert order
    const { error } = await supabase
      .from('orders')
      .insert([{
        customer_id: user.id,
        grain_details: grainDetails,
        total_price,
        status: 'new',
        token_number: token_number,
        service_type: service  // optional: track which service
      }]);

    if (error) {
      alert("Failed to place order!");
      console.error(error);
    } else {
      alert("Order placed successfully!");
      window.location.href = '/my-orders.html?phone=' + phone;
    }
  } catch (err) {
    console.error(err);
    alert("Failed to generate token number!");
  }
};
let deliveryCharge = 0;

async function fetchDeliveryChargeIfNeeded() {
  const service = localStorage.getItem("orderType") || localStorage.getItem("orderService") || "";
  // Only for Home by Mill
  if (!service.toLowerCase().includes("home by mill")) {
    deliveryCharge = 0;
    document.getElementById("delivery-row").style.display = "none";
    document.getElementById("delivery-cost").textContent = "â‚¹0.00";
    return;
  }

  // Try to get a global active price for home_by_mill (adjust the delivery_type if yours differs)
  const { data, error } = await supabase
    .from("delivery_pricing")
    .select("price")
    .eq("delivery_type", "home_by_mill")
    .eq("is_active", true)
    .limit(1)
    .maybeSingle();

  deliveryCharge = data ? Number(data.price) : 0;
  document.getElementById("delivery-row").style.display = "flex";
  document.getElementById("delivery-cost").textContent = `â‚¹${deliveryCharge.toFixed(2)}`;
}


fetchData();
</script>
</body>
</html>
